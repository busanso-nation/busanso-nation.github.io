<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BUSANSO â€“ Movie Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Load movies data -->
<script src="movies-data.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial,sans-serif;padding:16px}
h1{margin-bottom:10px;text-align:center}
.player{width:100%;max-width:800px;margin:0 auto;background:#000}
.player iframe{width:100%;height:56vw;max-height:450px;border:none}
.details{max-width:800px;margin:16px auto;padding:16px;background:#111;border-radius:12px}
.meta{color:#aaa;font-size:14px;margin-bottom:10px}
.actions button{
  width:100%;padding:12px;margin-top:8px;border:none;border-radius:8px;
  font-weight:bold;cursor:pointer;font-size:14px;
}
.watch{background:#e50914;color:#fff}
.secondary{background:#222;color:#fff;margin-top:4px}
.share{background:#555;color:#fff;margin-top:4px}
.cast span{background:#181818;padding:6px 10px;border-radius:20px;font-size:12px;margin-right:4px;margin-bottom:4px;display:inline-block;}
</style>
</head>

<body>

<script>
// ----- PIN CHECK -----
const pin = localStorage.getItem("activePIN");
const exp = Number(localStorage.getItem("pinExpiry"));
if(!pin || !exp || Date.now() > exp){
  localStorage.removeItem("activePIN");
  localStorage.removeItem("pinExpiry");
  alert("You must enter a valid PIN to watch movies.");
  location.replace("login.html"); // redirect to PIN entry/login
}
</script>

<div class="player" id="player"></div>

<div class="details">
  <h1 id="title"></h1>
  <div class="meta" id="meta"></div>

  <div class="actions">
    <button class="watch" id="watchBtn">â–¶ Watch Movie</button>
    <button class="share" onclick="shareWhatsApp()">ðŸ“² Share on WhatsApp</button>
    <button class="share" onclick="shareIMO()">ðŸ“© Share on IMO</button>
    <button class="share" onclick="shareTikTok()">ðŸŽµ Share on TikTok</button>
    <button class="share" onclick="copyToClipboard()">ðŸ“‹ Copy Info</button>
  </div>

  <div class="section">
    <h3>Synopsis</h3>
    <p id="synopsis"></p>
  </div>

  <div class="section">
    <h3>Cast</h3>
    <div class="cast" id="cast"></div>
  </div>
</div>

<script>
// ----- Get movie ID -----
const params = new URLSearchParams(location.search);
const id = params.get("id");
if(!id) location.replace("movies.html");

// ----- Find movie -----
const movie = MOVIES.find(m=>m.id===id);
if(!movie) location.replace("movies.html");

// ----- Populate info -----
document.getElementById("title").textContent = movie.title;
document.getElementById("meta").textContent = `${movie.country} â€¢ ${movie.year} â€¢ ${movie.duration || ''}`;
document.getElementById("synopsis").textContent = movie.synopsis || "";
const castDiv = document.getElementById("cast");
if(movie.cast) movie.cast.forEach(c=>{
  const span = document.createElement("span");
  span.textContent = c;
  castDiv.appendChild(span);
});

// ----- Normalize video URLs -----
function normalizeVideo(url){
  if(!url) return null;
  try{
    if(url.includes("youtube.com/watch")) return "https://www.youtube.com/embed/"+new URL(url).searchParams.get("v");
    if(url.includes("youtu.be/")) return "https://www.youtube.com/embed/"+url.split("youtu.be/")[1].split("?")[0];
    if(url.includes("youtube.com/embed")) return url;
    if(url.includes("vimeo.com")) return "https://player.vimeo.com/video/"+url.split("/").pop().split("?")[0];
    if(url.includes("/d/")) return "https://drive.google.com/file/d/"+url.split("/d/")[1].split("/")[0]+"/preview";
    if(url.includes("drive.google.com/open")) return "https://drive.google.com/file/d/"+(new URL(url).searchParams.get("id"))+"/preview";
    return url;
  }catch(e){return null;}
}

// ----- Play movie -----
function playMovie(){
  const embed = normalizeVideo(movie.video);
  if(!embed){ alert("Video not supported"); return; }
  document.getElementById("player").innerHTML = `<iframe src="${embed}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
}
document.getElementById("watchBtn").onclick = playMovie;

// ----- Share functions -----
const SITE_URL = location.origin + "/movies.html";
function shareWhatsApp(){
  location.href = `https://wa.me/?text=${encodeURIComponent(movie.title + "\n" + movie.synopsis + "\nWatch on BUSANSO: " + SITE_URL)}`;
}
function shareIMO(){
  location.href = `imo://send?text=${encodeURIComponent(movie.title + "\n" + movie.synopsis + "\nWatch on BUSANSO: " + SITE_URL)}`;
}
function shareTikTok(){
  alert("TikTok share is not native, you can copy and post manually.");
}
function copyToClipboard(){
  const text = `${movie.title}\n${movie.synopsis}\nWatch on BUSANSO: ${SITE_URL}`;
  navigator.clipboard.writeText(text).then(()=>alert("Movie info copied!"));
}
</script>

</body>
</html>
