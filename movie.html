<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BUSANSO – Watch</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Arial, sans-serif;
}

.player iframe{
  width:100%;
  height:56vw;
  max-height:75vh;
  border:none;
  background:#000;
}

.details{
  padding:16px;
}

.meta{
  color:#aaa;
  font-size:14px;
  margin-bottom:10px;
}

.synopsis{
  font-size:14px;
  line-height:1.5;
  margin-bottom:16px;
}

.actions button{
  width:100%;
  margin-top:8px;
  padding:12px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  background:#222;
  color:#fff;
}
</style>
</head>

<body>

<script>
/* ===== SAFE PIN CHECK (GITHUB FIXED) ===== */
document.addEventListener("DOMContentLoaded", () => {

  const pin = localStorage.getItem("activePIN");
  const exp = parseInt(localStorage.getItem("pinExpiry"), 10);

  if (!pin || !exp || isNaN(exp)) {
    redirectLogin();
    return;
  }

  if (Date.now() > exp) {
    localStorage.removeItem("activePIN");
    localStorage.removeItem("pinExpiry");
    redirectLogin();
  }
});

function redirectLogin(){
  const base = location.pathname.includes("/")
    ? location.pathname.split("/").slice(0,-1).join("/")
    : "";
  location.href = base + "/login.html";
}
</script>

<div class="player" id="player"></div>

<div class="details">
  <h2 id="title"></h2>
  <div class="meta" id="meta"></div>
  <div class="synopsis" id="synopsis"></div>

  <div class="actions">
    <button onclick="shareWA()">WhatsApp</button>
    <button onclick="shareMail()">Gmail</button>
    <button onclick="shareTT()">TikTok</button>
    <button onclick="copyShare()">Copy</button>
  </div>
</div>

<script>
/* ===== READ PARAMS ===== */
const q = new URLSearchParams(location.search);

const title     = q.get("title");
const rawVideo  = q.get("video");
const year      = q.get("year");
const country   = q.get("country");
const duration  = q.get("duration");
const synopsis  = q.get("synopsis");

if(!rawVideo || !title){
  location.href = "movies.html";
}

/* ===== VIDEO NORMALIZER ===== */
function getEmbed(url){

  if(url.includes("youtube.com/watch")){
    return "https://www.youtube.com/embed/" +
      new URL(url).searchParams.get("v");
  }

  if(url.includes("youtu.be/")){
    return "https://www.youtube.com/embed/" +
      url.split("youtu.be/")[1];
  }

  if(url.includes("vimeo.com")){
    return "https://player.vimeo.com/video/" +
      url.split("/").pop();
  }

  if(url.includes("drive.google.com")){
    const id = url.match(/\/d\/([^/]+)/);
    if(id) return `https://drive.google.com/file/d/${id[1]}/preview`;
  }

  return url;
}

document.getElementById("player").innerHTML =
  `<iframe id="videoFrame" src="${getEmbed(rawVideo)}" allowfullscreen></iframe>`;

/* ===== DETAILS ===== */
document.getElementById("title").textContent = title;
document.getElementById("meta").textContent =
  `${country} • ${year} • ${duration}`;
document.getElementById("synopsis").textContent = synopsis;

/* ===== SHARE ===== */
const HOME_URL = location.origin + "/movies.html";

const shareText =
`${title}

Country: ${country}
Year: ${year}
Duration: ${duration}

${synopsis}

Watch on BUSANSO NATION:
${HOME_URL}`;

function shareWA(){
  location.href = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
}
function shareMail(){
  location.href = `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(shareText)}`;
}
function shareTT(){
  location.href = `https://www.tiktok.com/share?text=${encodeURIComponent(shareText)}`;
}
function copyShare(){
  navigator.clipboard.writeText(shareText);
  alert("Copied");
}

/* ===== MOBILE FULLSCREEN ===== */
function isMobile(){
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}
function goFullscreen(){
  const f = document.getElementById("videoFrame");
  if(!f) return;

  try{
    if(f.requestFullscreen){
      f.requestFullscreen().catch(()=>{});
    }

    if(screen.orientation && screen.orientation.lock){
      screen.orientation.lock("landscape").catch(()=>{});
    }
  }catch(e){}
}

</script>

</body>
</html>
