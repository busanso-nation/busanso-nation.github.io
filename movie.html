<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BUSANSO – Watch</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Arial, sans-serif;
}

.player iframe{
  width:100%;
  height:56vw;
  max-height:75vh;
  border:none;
  background:#000;
}

.details{
  padding:16px;
}

.meta{
  color:#aaa;
  font-size:14px;
  margin-bottom:10px;
}

.synopsis{
  font-size:14px;
  line-height:1.5;
  margin-bottom:16px;
}

.actions button{
  width:100%;
  margin-top:8px;
  padding:12px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  background:#222;
  color:#fff;
}
</style>
</head>

<body>

<!-- ===== PIN CHECK (ONLY SECURITY) ===== -->
<script>
const pin = localStorage.getItem("activePIN");
const exp = Number(localStorage.getItem("pinExpiry"));

if (!pin || !exp || isNaN(exp) || Date.now() > exp) {
  localStorage.removeItem("activePIN");
  localStorage.removeItem("pinExpiry");
  location.replace("login.html");
}
</script>

<div class="player" id="player"></div>

<div class="details">
  <h2 id="title"></h2>
  <div class="meta" id="meta"></div>
  <div class="synopsis" id="synopsis"></div>

  <div class="actions">
    <button onclick="shareWA()">WhatsApp</button>
    <button onclick="shareMail()">Gmail</button>
    <button onclick="shareTT()">TikTok</button>
    <button onclick="copyShare()">Copy</button>
  </div>
</div>

<script>
/* ===== READ PARAMS ===== */
const q = new URLSearchParams(location.search);

const title     = q.get("title");
const rawVideo  = q.get("video");
const year      = q.get("year");
const country   = q.get("country");
const duration  = q.get("duration");
const synopsis  = q.get("synopsis");

if(!rawVideo || !title){
  location.replace("movies.html");
}

/* ===== VIDEO NORMALIZER ===== */
function getEmbed(url){
  // YouTube
  if(url.includes("youtube.com/watch")){
    return "https://www.youtube.com/embed/" +
      new URL(url).searchParams.get("v");
  }
  if(url.includes("youtu.be/")){
    return "https://www.youtube.com/embed/" +
      url.split("youtu.be/")[1];
  }

  // Vimeo
  if(url.includes("vimeo.com")){
    const id = url.split("/").pop();
    return "https://player.vimeo.com/video/" + id;
  }

  // Google Drive
  if(url.includes("drive.google.com")){
    if(url.includes("/preview")) return url;
    const id = url.match(/\/d\/([^/]+)/);
    if(id) return `https://drive.google.com/file/d/${id[1]}/preview`;
  }

  return url;
}

const video = getEmbed(rawVideo);

/* ===== PLAYER ===== */
document.getElementById("player").innerHTML =
  `<iframe id="videoFrame" src="${video}" allowfullscreen></iframe>`;

/* ===== DETAILS ===== */
document.getElementById("title").textContent = title;
document.getElementById("meta").textContent =
  `${country} • ${year} • ${duration}`;
document.getElementById("synopsis").textContent = synopsis;

/* ===== SHARE (NO VIDEO URL) ===== */
const HOME_URL = location.origin + "/movies.html";

const shareText =
`${title}

Country: ${country}
Year: ${year}
Duration: ${duration}

${synopsis}

Watch on BUSANSO:
${HOME_URL}`;

function shareWA(){
  location.href =
    `https://wa.me/?text=${encodeURIComponent(shareText)}`;
}

function shareMail(){
  location.href =
    `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(shareText)}`;
}

function shareTT(){
  location.href =
    `https://www.tiktok.com/share?text=${encodeURIComponent(shareText)}`;
}

function copyShare(){
  navigator.clipboard.writeText(shareText);
  alert("Copied");
}

/* ===== MOBILE FULLSCREEN + LANDSCAPE ===== */
function isMobile(){
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

function enterFullscreenLandscape(){
  const iframe = document.getElementById("videoFrame");
  if(!iframe) return;

  if(iframe.requestFullscreen){
    iframe.requestFullscreen();
  }else if(iframe.webkitRequestFullscreen){
    iframe.webkitRequestFullscreen();
  }

  if(screen.orientation && screen.orientation.lock){
    screen.orientation.lock("landscape").catch(()=>{});
  }
}

document.addEventListener("fullscreenchange",()=>{
  if(!document.fullscreenElement){
    if(screen.orientation && screen.orientation.unlock){
      screen.orientation.unlock();
    }
  }
});

if(isMobile()){
  setTimeout(enterFullscreenLandscape, 800);
}
</script>

</body>
</html>
