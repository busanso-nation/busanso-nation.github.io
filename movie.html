<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Watch Movie • BUSANSO MOVIES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Video SDKs -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://player.vimeo.com/api/player.js"></script>

  <!-- Movie data -->
  <script src="movies-data.js"></script>

  <style>
    body{
      margin:0;
      font-family:Arial, sans-serif;
      background:#000;
      color:#fff;
    }
    header{
      padding:15px;
      text-align:center;
      background:#111;
      font-size:20px;
      font-weight:bold;
    }
    #movieInfo{
      text-align:center;
      padding:10px;
      font-size:14px;
      color:#bbb;
    }
    #playerWrapper{
      display:flex;
      justify-content:center;
      padding:10px;
    }
    #player iframe,
    #player video{
      width:95vw;
      height:53.4vw; /* 16:9 */
      max-height:80vh;
      border:none;
      border-radius:12px;
      background:#000;
    }
    .back{
      text-align:center;
      margin:15px;
    }
    .back a{
      color:#e50914;
      text-decoration:none;
      font-size:14px;
    }
  </style>
</head>
<body>

<header>BUSANSO MOVIES</header>

<div id="movieInfo"></div>

<div id="playerWrapper">
  <div id="player"></div>
</div>

<div class="back">
  <a href="home.html">← Back to movies</a>
</div>

<script>
let currentPlayer = null;

/* ===== helpers ===== */
function getParam(name){
  return new URLSearchParams(window.location.search).get(name);
}

function getYouTubeId(url){
  if(url.includes('youtu.be/')) return url.split('youtu.be/')[1].split(/[?&]/)[0];
  if(url.includes('/embed/')) return url.split('/embed/')[1].split(/[?&]/)[0];
  if(url.includes('v=')) return url.split('v=')[1].split('&')[0];
  return null;
}

/* ===== main ===== */
function loadMovie(){
  const id = parseInt(getParam('id'));
  if(isNaN(id) || !MOVIES[id]){
    document.getElementById('player').innerHTML =
      '<p style="text-align:center">Movie not found</p>';
    return;
  }

  const movie = MOVIES[id];
  document.getElementById('movieInfo').innerText =
    `${movie.title} • ${movie.country} • ${movie.year} • ${movie.genre}`;

  playVideo(movie.video);
}

function playVideo(url){
  const container = document.getElementById('player');
  container.innerHTML = '';

  // YouTube
  const ytId = getYouTubeId(url);
  if(ytId){
    container.innerHTML = `<div id="ytplayer"></div>`;
    currentPlayer = new YT.Player('ytplayer', {
      videoId: ytId,
      events:{
        onReady:e=>{
          const saved = localStorage.getItem('yt_'+ytId);
          if(saved) e.target.seekTo(parseFloat(saved));
          e.target.playVideo();
        },
        onStateChange:e=>{
          if(e.data === YT.PlayerState.PLAYING){
            if(window.__ytInterval) clearInterval(window.__ytInterval);
            window.__ytInterval = setInterval(()=>{
              localStorage.setItem('yt_'+ytId, e.target.getCurrentTime());
            },3000);
          }
        }
      }
    });
    return;
  }

  // Vimeo
  if(url.includes('vimeo.com/')){
    const id = url.split('vimeo.com/')[1].split(/[?&]/)[0];
    container.innerHTML =
      `<iframe src="https://player.vimeo.com/video/${id}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
    const iframe = container.querySelector('iframe');
    currentPlayer = new Vimeo.Player(iframe);
    const key = 'vimeo_'+id;
    currentPlayer.on('loaded',()=>{
      const saved = localStorage.getItem(key);
      if(saved) currentPlayer.setCurrentTime(parseFloat(saved));
    });
    currentPlayer.on('timeupdate',d=>{
      localStorage.setItem(key,d.seconds);
    });
    return;
  }

  // Google Drive
  if(url.includes('drive.google.com/file/d/')){
    const match = url.match(/\/d\/(.*?)\//);
    if(match){
      container.innerHTML =
        `<iframe src="https://drive.google.com/file/d/${match[1]}/preview" allow="autoplay"></iframe>`;
      return;
    }
  }

  // MP4 fallback
  container.innerHTML =
    `<video controls autoplay><source src="${url}" type="video/mp4"></video>`;
}

loadMovie();
</script>

</body>
</html>
