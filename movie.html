<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BUSANSO â€“ Watch</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="movies-data.js"></script>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Arial, sans-serif;
}

.player iframe{
  width:100%;
  height:56vw;
  max-height:75vh;
  border:none;
}

.details{padding:16px}
.meta{color:#aaa;font-size:14px}
.synopsis{font-size:14px;margin-top:10px}

.actions button{
  width:100%;
  margin-top:10px;
  padding:14px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}
.watch{background:#e50914;color:#fff}
.share{background:#222;color:#fff}

.reco{padding:16px}
.recoRow{
  display:flex;
  gap:12px;
  overflow-x:auto;
}
.recoRow img{
  width:140px;
  border-radius:8px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="player" id="player"></div>

<div class="details">
  <h2 id="title"></h2>
  <div class="meta" id="meta"></div>
  <p class="synopsis" id="synopsis"></p>

  <div class="actions">
    <button class="watch" onclick="watchNow()">â–¶ WATCH NOW</button>
    <button class="share" onclick="openShare()">ðŸ”— SHARE</button>
  </div>
</div>

<div class="reco">
  <h3>Recommended</h3>
  <div class="recoRow" id="reco"></div>
</div>

<!-- SHARE OPTIONS -->
<div id="shareSheet" style="display:none;padding:16px">
  <button onclick="shareWA()">WhatsApp</button>
  <button onclick="shareIMO()">IMO</button>
  <button onclick="shareTT()">TikTok</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ===== SAFE PIN CHECK ===== */
  const pin = localStorage.getItem("activePIN");
  const exp = Number(localStorage.getItem("pinExpiry"));

  if(!pin || !exp || Date.now() > exp){
    localStorage.clear();
    location.href = "login.html";
    return;
  }

  /* ===== READ PARAM ===== */
  const q = new URLSearchParams(location.search);
  const id = q.get("id");

  if(!id){
    showError("Movie not found.");
    return;
  }

  const movie = MOVIES.find(m => String(m.id) === String(id));
  if(!movie){
    showError("Movie not found.");
    return;
  }

  /* ===== DETAILS ===== */
  title.textContent = movie.title;
  meta.textContent = `${movie.genre}${movie.duration ? " â€¢ "+movie.duration : ""}`;
  synopsis.textContent = movie.synopsis;

  /* ===== PLAYER ===== */
  function embed(url){
    if(url.includes("youtube")){
      const vid = url.includes("youtu.be")
        ? url.split("youtu.be/")[1]
        : new URL(url).searchParams.get("v");
      return `https://www.youtube.com/embed/${vid}`;
    }
    if(url.includes("vimeo")){
      return "https://player.vimeo.com/video/" + url.split("/").pop();
    }
    if(url.includes("drive.google.com")){
      const id = url.match(/\/d\/([^/]+)/);
      if(id) return `https://drive.google.com/file/d/${id[1]}/preview`;
    }
    return url;
  }

  window.watchNow = function(){
    player.innerHTML =
      `<iframe id="videoFrame" src="${embed(movie.video)}" allowfullscreen></iframe>`;
    setTimeout(goFullscreen,500);
  };

  function goFullscreen(){
    const f = document.getElementById("videoFrame");
    if(!f) return;
    f.requestFullscreen?.();
    screen.orientation?.lock("landscape").catch(()=>{});
  }

  /* ===== SHARE ===== */
  const SITE_URL = location.origin + "/movies.html";
  const shareText =
`${movie.title}

Genre: ${movie.genre}
Duration: ${movie.duration || "N/A"}

${movie.synopsis}

Watch on BUSANSO:
${SITE_URL}`;

  window.openShare = ()=> shareSheet.style.display="block";
  window.shareWA = ()=> location.href=`https://wa.me/?text=${encodeURIComponent(shareText)}`;
  window.shareIMO = ()=> location.href=`imo://send?text=${encodeURIComponent(shareText)}`;
  window.shareTT = ()=> location.href=`https://www.tiktok.com/share?text=${encodeURIComponent(shareText)}`;

  /* ===== RECOMMENDATIONS ===== */
  MOVIES
    .filter(m => m.genre === movie.genre && m.id !== movie.id)
    .slice(0,6)
    .forEach(m=>{
      const img=document.createElement("img");
      img.src=m.poster;
      img.onclick=()=>location.href=`watch.html?id=${m.id}`;
      reco.appendChild(img);
    });
});

/* ===== ERROR HANDLER ===== */
function showError(msg){
  document.body.innerHTML =
    `<div style="padding:40px;text-align:center">
      <h2>${msg}</h2>
      <button onclick="location.href='movies.html'">Back to Movies</button>
     </div>`;
}
</script>

</body>
</html>
