<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Movie Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="movies-data.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "busanso-pins.firebaseapp.com",
  databaseURL: "https://busanso-pins-default-rtdb.firebaseio.com",
  projectId: "busanso-pins",
  storageBucket: "busanso-pins.appspot.com",
  messagingSenderId: "137040014808",
  appId: "1:137040014808:web:b0684e17b6b0328da596ad"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<style>
/* Keep your same styles here (unchanged) */
body{margin:0;background:#111;color:#fff;font-family:Arial;}
.banner{position:relative;height:55vh;display:flex;align-items:flex-end;justify-content:center;}
.banner img{width:100%;height:100%;object-fit:cover;}
.banner .buttons{position:absolute;bottom:30px;display:flex;gap:12px;}
button{padding:14px 28px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;}
#watchBtn{background:#e50914;color:#fff;}
#shareBtn{background:#25D366;color:#fff;}
.details{max-width:900px;margin:20px auto;padding:0 16px;}
.player{width:90%;max-width:1200px;margin:20px auto;aspect-ratio:16/9;display:none;border-radius:12px;}
#adOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;
display:none;justify-content:center;align-items:center;flex-direction:column;z-index:9999;}
.countdown{font-size:24px;color:#00ff99;margin:15px 0;}
#upgradePopup{position:fixed;bottom:20px;right:20px;background:#1c1c1c;
padding:20px;border-radius:12px;display:none;}
</style>
</head>

<body>

<div class="banner">
  <img id="posterImg">
  <div class="buttons">
    <button id="watchBtn">â–¶ Watch Now</button>
    <button id="shareBtn">Share</button>
  </div>
</div>

<div class="details">
  <h1 id="title"></h1>
  <p id="synopsis"></p>
  <p id="meta"></p>
</div>

<iframe id="player" class="player" allowfullscreen></iframe>
<div id="bannerAd" style="text-align:center;margin:20px 0;"></div>

<div id="adOverlay">
  <h2>Advertisement</h2>
  <div class="countdown" id="countdown">10</div>
  <p>Your movie will start shortly...</p>
</div>

<div id="upgradePopup">
  <h3>Remove Ads ðŸš€</h3>
  <p>Upgrade to premium for ad-free streaming.</p>
  <button onclick="window.location.href='upgrade.html'">
    Upgrade Now
  </button>
</div>

<script>

// ===== GET MOVIE =====
const params = new URLSearchParams(location.search);
const id = params.get("id");
if(!id) location.href="movies-list.html";
const movie = MOVIES.find(m => m.id === id);
if(!movie) location.href="movies-list.html";

// Populate
title.textContent = movie.title;
posterImg.src = movie.poster;
synopsis.textContent = movie.synopsis || "";
meta.textContent = `${movie.year} â€¢ ${movie.duration||""}`;

// Normalize URLs
function getVideoUrl(url){
  if(url.includes("youtube")){
    const ytId = new URL(url).searchParams.get("v");
    return `https://www.youtube.com/embed/${ytId}?autoplay=1`;
  }
  if(url.includes("/d/")){
    const driveId = url.split("/d/")[1].split("/")[0];
    return `https://drive.google.com/file/d/${driveId}/preview`;
  }
  return url;
}

const player = document.getElementById("player");
const adOverlay = document.getElementById("adOverlay");
const countdownEl = document.getElementById("countdown");
let isPaidUser = false;

// ===== VERIFY PIN FROM FIREBASE =====
async function verifyPIN(){

  const storedPIN = localStorage.getItem("validPIN");
  const storedDevice = localStorage.getItem("deviceId");

  if(!storedPIN || !storedDevice){
    return false;
  }

  try {

    const snapshot = await db.ref("pins/" + storedPIN).once("value");

    if(!snapshot.exists()){
      localStorage.removeItem("validPIN");
      return false;
    }

    const data = snapshot.val();

    // 1ï¸âƒ£ Must be used
    if(!data.used){
      localStorage.removeItem("validPIN");
      return false;
    }

    // 2ï¸âƒ£ Must not be expired
    if(Date.now() > data.expiry){
      localStorage.removeItem("validPIN");
      return false;
    }

    // 3ï¸âƒ£ Must match active device
    if(data.activeDevice !== storedDevice){
      localStorage.removeItem("validPIN");
      return false;
    }

    // Everything valid
    return true;

  } catch(err){
    console.error("Firebase verification error:", err);
    return false;
  }
}


// ===== START MOVIE =====
function startMovie(){
  player.src = getVideoUrl(movie.video);
  player.style.display="block";
  posterImg.style.display="none";
  watchBtn.style.display="none";
  shareBtn.style.display="none";
}

// ===== AD FLOW =====
function playWithAd(){

  adOverlay.style.display="flex";
  let timeLeft = 10;
  countdownEl.textContent = timeLeft;

  window.open(
    "https://www.effectivegatecpm.com/bur4x69piu?key=111989f663f7a1507cb9aee022725797",
    "_blank"
  );

  const timer = setInterval(()=>{
    timeLeft--;
    countdownEl.textContent = timeLeft;

    if(timeLeft <= 0){
      clearInterval(timer);
      adOverlay.style.display="none";
      startMovie();
    }
  },1000);
}

// ===== INIT =====
verifyPIN().then(valid => {
  isPaidUser = valid;

  if(!isPaidUser){
    document.getElementById("upgradePopup").style.display="block";

    // Load Ads
    const social=document.createElement("script");
    social.src="https://pl28597623.effectivegatecpm.com/47/af/6b/47af6bb4248b5c79dabea6b329d6d72f.js";
    document.body.appendChild(social);

    const banner=document.getElementById("bannerAd");
    banner.innerHTML=`
      <script>
        atOptions={
          'key':'1c9ccdb756a82c4d663014a338917bd7',
          'format':'iframe',
          'height':250,
          'width':300,
          'params':{}
        };
      <\/script>
      <script src="https://www.highperformanceformat.com/1c9ccdb756a82c4d663014a338917bd7/invoke.js"><\/script>
    `;
  }
});

// ===== WATCH CLICK =====
watchBtn.addEventListener("click",()=>{
  if(isPaidUser){
    startMovie();
  } else {
    playWithAd();
  }
});

// ===== SHARE =====
shareBtn.addEventListener("click",()=>{
  const text=`ðŸŽ¬ ${movie.title}\nWatch now`;
  window.open(
    "https://api.whatsapp.com/send?text="+encodeURIComponent(text),
    "_blank"
  );
});

</script>

</body>
</html>
