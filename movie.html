<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BUSANSO â€“ Movie Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="movies-data.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBGGV9F3Nv13nRJ8t4QCP5Y0IosmKfYz1s",
  authDomain: "busanso-pins.firebaseapp.com",
  databaseURL: "https://busanso-pins-default-rtdb.firebaseio.com",
  projectId: "busanso-pins",
  storageBucket: "busanso-pins.firebasestorage.app",
  messagingSenderId: "137040014808",
  appId: "1:137040014808:web:b0684e17b6b0328da596ad"
};
firebase.initializeApp(firebaseConfig);
</script>

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial,sans-serif;padding:16px}
.player{max-width:800px;margin:0 auto}
.player iframe{width:100%;height:56vw;max-height:450px;border:none}
.details{max-width:800px;margin:16px auto;background:#111;padding:16px;border-radius:12px}
.meta{color:#aaa;font-size:14px}
.actions button{width:100%;padding:12px;margin-top:8px;border:none;border-radius:8px;font-weight:bold}
.watch{background:#e50914;color:#fff}

/* COMMENTS */
#commentsSection{max-width:800px;margin:20px auto;background:#111;padding:16px;border-radius:12px}
#commentsList div{background:#222;padding:8px 10px;border-radius:8px;margin-bottom:6px;position:relative}
#usernameInput,#commentInput{width:100%;padding:8px;border-radius:6px;background:#111;color:#fff;border:none;margin-bottom:6px}
#commentBtn{padding:8px 16px;border:none;border-radius:8px;background:#e50914;color:#fff;font-weight:bold}
</style>
</head>

<body>

<script>
// PIN CHECK (unchanged)
const pin=localStorage.getItem("activePIN");
const exp=Number(localStorage.getItem("pinExpiry"));
if(!pin||!exp||Date.now()>exp){
  localStorage.clear();
  location.replace("packages.html");
}
</script>

<div class="player" id="player"></div>

<div class="details">
  <h1 id="title"></h1>
  <div class="meta" id="meta"></div>
  <button class="watch" id="watchBtn">â–¶ Watch Movie</button>
  <p id="synopsis"></p>
</div>

<!-- COMMENTS -->
<div id="commentsSection">
  <h3>Comments</h3>
  <input id="usernameInput" placeholder="Your nickname">
  <div id="commentsList"></div>
  <textarea id="commentInput" placeholder="Write your comment"></textarea>
  <button id="commentBtn">Post Comment</button>
</div>

<script>
// MOVIE LOAD
const params=new URLSearchParams(location.search);
const id=params.get("id");
const movie=MOVIES.find(m=>m.id===id);
if(!movie) location.replace("movies.html");

title.textContent=movie.title;
meta.textContent=`${movie.country} â€¢ ${movie.year}`;
synopsis.textContent=movie.synopsis||"";

// VIDEO
function normalizeVideo(url){
  if(url.includes("youtube")) return "https://www.youtube.com/embed/"+new URL(url).searchParams.get("v");
  if(url.includes("vimeo")) return "https://player.vimeo.com/video/"+url.split("/").pop();
  if(url.includes("/d/")) return "https://drive.google.com/file/d/"+url.split("/d/")[1].split("/")[0]+"/preview";
  return url;
}

watchBtn.onclick=()=>{
  if(movie.type!=="free") return location.href="packages.html";
  player.innerHTML=`<iframe src="${normalizeVideo(movie.video)}" allowfullscreen></iframe>`;
};

// COMMENTS LOGIC (HARDENED)
const commentsRef=firebase.database().ref("comments/movies/"+movie.id);
const usernameInput=document.getElementById("usernameInput");
const commentInput=document.getElementById("commentInput");

usernameInput.value=localStorage.getItem("username")||"";

commentBtn.onclick=()=>{
  const user=usernameInput.value.trim().slice(0,20);
  const text=commentInput.value.trim().slice(0,300);
  if(!user||!text) return alert("Nickname and comment required");

  localStorage.setItem("username",user);

  commentsRef.push({
    user,
    text,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  });

  commentInput.value="";
};

commentsRef.limitToLast(100).on("value",snap=>{
  commentsList.innerHTML="";
  const arr=[];
  snap.forEach(c=>arr.push({...c.val(),ref:c.ref}));
  arr.sort((a,b)=>b.timestamp-a.timestamp);

  arr.forEach(c=>{
    const d=document.createElement("div");
    d.innerHTML=`<strong>${c.user}</strong>: ${c.text}`;

    if(localStorage.getItem("activePIN")==="Orion196"){
      const b=document.createElement("button");
      b.textContent="ðŸ—‘";
      Object.assign(b.style,{position:"absolute",right:"6px",top:"6px",background:"#e50914",color:"#fff",border:"none"});
      b.onclick=()=>c.ref.remove();
      d.appendChild(b);
    }

    commentsList.appendChild(d);
  });
});
</script>

</body>
</html>
