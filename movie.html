<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BUSANSO â€“ Movie Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Load movies data -->
<script src="movies-data.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  // Initialize Firebase (replace with your config)
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT.firebaseio.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
</script>

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial,sans-serif;padding:16px}
h1{margin-bottom:10px;text-align:center}
.player{width:100%;max-width:800px;margin:0 auto;background:#000}
.player iframe{width:100%;height:56vw;max-height:450px;border:none}
.details{max-width:800px;margin:16px auto;padding:16px;background:#111;border-radius:12px}
.meta{color:#aaa;font-size:14px;margin-bottom:10px}
.actions button{
  width:100%;padding:12px;margin-top:8px;border:none;border-radius:8px;
  font-weight:bold;cursor:pointer;font-size:14px;
}
.watch{background:#e50914;color:#fff}
.secondary{background:#222;color:#fff;margin-top:4px}
.share{background:#555;color:#fff;margin-top:4px}
.cast span{background:#181818;padding:6px 10px;border-radius:20px;font-size:12px;margin-right:4px;margin-bottom:4px;display:inline-block;}
/* Comment Section */
#commentsSection{max-width:800px;margin:20px auto;background:#111;padding:16px;border-radius:12px;}
#commentsList div{margin-bottom:6px;padding:8px 10px;background:#222;border-radius:8px;position:relative;}
#commentInput{width:100%;padding:8px;border-radius:6px;background:#111;color:#fff;border:none;margin-top:6px;}
#commentBtn{margin-top:6px;padding:8px 16px;border:none;border-radius:8px;background:#e50914;color:#fff;font-weight:bold;cursor:pointer;}
</style>
</head>

<body>

<script>
// ----- PIN CHECK -----
const pin = localStorage.getItem("activePIN");
const exp = Number(localStorage.getItem("pinExpiry"));
if(!pin || !exp || Date.now() > exp){
  localStorage.removeItem("activePIN");
  localStorage.removeItem("pinExpiry");
  location.replace("packages.html"); // redirect to PIN entry/login
}
</script>

<div class="player" id="player"></div>

<div class="details">
  <h1 id="title"></h1>
  <div class="meta" id="meta"></div>

  <div class="actions">
    <button class="watch" id="watchBtn">â–¶ Watch Movie</button>
    <button class="share" onclick="shareWhatsApp()">ðŸ“² Share on WhatsApp</button>
    <button class="share" onclick="shareIMO()">ðŸ“© Share on IMO</button>
    <button class="share" onclick="shareTikTok()">ðŸŽµ Share on TikTok</button>
    <button class="share" onclick="copyToClipboard()">ðŸ“‹ Copy Info</button>
  </div>

  <div class="section">
    <h3>Synopsis</h3>
    <p id="synopsis"></p>
  </div>

  <div class="section">
    <h3>Cast</h3>
    <div class="cast" id="cast"></div>
  </div>
</div>

<!-- ===== COMMENT SECTION ===== -->
<div id="commentsSection">
  <h3>Comments</h3>
  <div id="commentsList"></div>
  <textarea id="commentInput" placeholder="Write your comment"></textarea>
  <button id="commentBtn">Post Comment</button>
</div>

<script>
// ----- Get movie ID -----
const params = new URLSearchParams(location.search);
const id = params.get("id");
if(!id) location.replace("movies.html");

// ----- Find movie -----
const movie = MOVIES.find(m=>m.id===id);
if(!movie) location.replace("movies.html");

// ----- Populate info -----
document.getElementById("title").textContent = movie.title;
document.getElementById("meta").textContent = `${movie.country} â€¢ ${movie.year} â€¢ ${movie.duration || ''}`;
document.getElementById("synopsis").textContent = movie.synopsis || "";
const castDiv = document.getElementById("cast");
if(movie.cast) movie.cast.forEach(c=>{
  const span = document.createElement("span");
  span.textContent = c;
  castDiv.appendChild(span);
});

// ----- Normalize video URLs -----
function normalizeVideo(url){
  if(!url) return null;
  try{
    if(url.includes("youtube.com/watch")) return "https://www.youtube.com/embed/"+new URL(url).searchParams.get("v");
    if(url.includes("youtu.be/")) return "https://www.youtube.com/embed/"+url.split("youtu.be/")[1].split("?")[0];
    if(url.includes("youtube.com/embed")) return url;
    if(url.includes("vimeo.com")) return "https://player.vimeo.com/video/"+url.split("/").pop().split("?")[0];
    if(url.includes("/d/")) return "https://drive.google.com/file/d/"+url.split("/d/")[1].split("/")[0]+"/preview";
    if(url.includes("drive.google.com/open")) return "https://drive.google.com/file/d/"+(new URL(url).searchParams.get("id"))+"/preview";
    return url;
  }catch(e){return null;}
}

// ----- Play movie -----
function playMovie(){
  if(movie.type !== "free") { alert("This movie is premium!"); return; }
  const embed = normalizeVideo(movie.video);
  if(!embed){ alert("Video not supported"); return; }
  document.getElementById("player").innerHTML = `<iframe src="${embed}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
}
document.getElementById("watchBtn").onclick = playMovie;

// ----- Share functions -----
const SITE_URL = location.origin + "/movies.html";
function shareWhatsApp(){
  location.href = `https://wa.me/?text=${encodeURIComponent(movie.title + "\n" + movie.synopsis + "\nWatch on BUSANSO: " + SITE_URL)}`;
}
function shareIMO(){
  location.href = `imo://send?text=${encodeURIComponent(movie.title + "\n" + movie.synopsis + "\nWatch on BUSANSO: " + SITE_URL)}`;
}
function shareTikTok(){
  alert("TikTok share is not native, you can copy and post manually.");
}
function copyToClipboard(){
  const text = `${movie.title}\n${movie.synopsis}\nWatch on BUSANSO: ${SITE_URL}`;
  navigator.clipboard.writeText(text).then(()=>alert("Movie info copied!"));
}

// ===== COMMENT SECTION LOGIC =====
const commentsRef = firebase.database().ref("comments");

// Helper: get or set username
function getUsername() {
  let name = localStorage.getItem("username");
  if (!name) {
    name = prompt("Enter a nickname to comment:");
    if(name) localStorage.setItem("username", name.trim());
  }
  return name;
}

// Post comment
document.getElementById("commentBtn").onclick = () => {
  const text = document.getElementById("commentInput").value.trim();
  if(!text) return alert("Type something first");
  const username = getUsername();
  if(!username) return alert("Username required");
  commentsRef.push({ user: username, text, timestamp: Date.now() });
  document.getElementById("commentInput").value = "";
};

// Display comments live with admin delete
commentsRef.on("value", snapshot => {
  const container = document.getElementById("commentsList");
  container.innerHTML = "";
  snapshot.forEach(child => {
    const c = child.val();
    const div = document.createElement("div");
    div.innerHTML = `<strong>${c.user}</strong>: ${c.text}`;

    // Admin delete button (replace YOUR_ADMIN_PIN with your PIN)
    const isAdmin = localStorage.getItem("activePIN") === "YOUR_ADMIN_PIN";
    if(isAdmin){
      const delBtn = document.createElement("button");
      delBtn.textContent = "ðŸ—‘ Delete";
      delBtn.style.position = "absolute";
      delBtn.style.right = "8px";
      delBtn.style.top = "8px";
      delBtn.style.background="#e50914";
      delBtn.style.color="#fff";
      delBtn.style.border="none";
      delBtn.style.borderRadius="6px";
      delBtn.style.padding="2px 6px";
      delBtn.style.cursor="pointer";
      delBtn.onclick = () => child.ref.remove();
      div.appendChild(delBtn);
    }

    container.appendChild(div);
  });
});
</script>

</body>
</html>
