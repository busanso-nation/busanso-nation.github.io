<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Series</title>

<!-- OpenGraph -->
<meta property="og:type" content="website">
<meta property="og:site_name" content="BUSANSO NATION">
<meta property="og:title" content="">
<meta property="og:description" content="">
<meta property="og:image" content="">
<meta property="og:url" content="https://bit.ly/busanso">

<!-- Video.js -->
<link href="https://vjs.zencdn.net/8.11.2/video-js.css" rel="stylesheet">

<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: Arial, sans-serif;
}

.container {
  max-width: 1100px;
  margin: auto;
  padding: 12px;
}

/* TRUE WIDESCREEN PLAYER */
.player-wrapper {
  position: relative;
  width: 100%;
  aspect-ratio: 16 / 9;
  background: #000;
}

.video-js {
  width: 100%;
  height: 100%;
}

/* Buttons */
button {
  padding: 12px 18px;
  font-size: 15px;
  border: none;
  border-radius: 6px;
  margin: 6px 6px 6px 0;
  cursor: pointer;
}

.primary { background:#e50914; color:#fff; }
.secondary { background:#333; color:#fff; }
.nav { background:#1db954; color:#fff; }

#episodes button {
  width: 100%;
  margin: 4px 0;
}

/* Comments */
.comment-box textarea {
  width: 100%;
  height: 70px;
  background: #111;
  color: #fff;
  border: 1px solid #333;
  border-radius: 4px;
  padding: 6px;
}
</style>
</head>

<body>

<div class="container">

  <!-- PLAYER -->
  <div class="player-wrapper">
    <video
      id="player"
      class="video-js vjs-big-play-centered"
      controls
      playsinline
      preload="auto">
    </video>
  </div>

  <!-- NAV -->
  <div>
    <button id="prevEpisodeBtn" class="nav">‚èÆ Previous</button>
    <button id="nextEpisodeBtn" class="nav">‚è≠ Next</button>
  </div>

  <h2 id="seriesTitle"></h2>
  <p id="seriesMeta"></p>
  <p id="seriesSynopsis"></p>

  <button id="watchNowBtn" class="primary">‚ñ∂ Watch Now</button>
  <button id="toggleEpisodesBtn" class="secondary">Show / Hide Episodes</button>
  <button id="shareBtn" class="secondary">üì§ Share</button>

  <div id="episodes"></div>

  <div class="comment-box">
    <textarea id="commentInput" placeholder="Add a comment..."></textarea>
    <button id="submitComment" class="primary">Submit</button>
    <div id="commentList"></div>
  </div>

</div>

<!-- DATA & LOGIC (UNCHANGED) -->
<script src="series-data.js"></script>
<script src="auth.js"></script>
<script src="pins.js"></script>
<script src="ads.js"></script>

<!-- Video.js -->
<script src="https://vjs.zencdn.net/8.11.2/video.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/videojs-youtube/dist/videojs-youtube.min.js"></script>

<script>
/* ===============================
   SERIES LOAD
================================ */
const params = new URLSearchParams(location.search);
const seriesId = params.get("id");
const serie = SERIES.find(s => s.id === seriesId);
if (!serie) location.replace("series.html");

seriesTitle.textContent = serie.title;
seriesMeta.textContent = `${serie.genre} ‚Ä¢ ${serie.country} ‚Ä¢ ${serie.year}`;
seriesSynopsis.textContent = serie.synopsis || "";

document.querySelector('meta[property="og:title"]').content = serie.title;
document.querySelector('meta[property="og:description"]').content = serie.synopsis || "";
document.querySelector('meta[property="og:image"]').content = serie.poster;

/* ===============================
   VIDEO.JS INIT
================================ */
const player = videojs("player", {
  techOrder: ["html5", "youtube"],
  autoplay: false,
  controls: true,
  fluid: true
});

/* ===============================
   VIDEO URL NORMALIZER
================================ */
function normalizeVideo(url) {
  if (!url) return null;

  // YouTube (watch / embed / youtu.be)
  if (/youtu\.?be/.test(url)) {
    return { src: url, type: "video/youtube" };
  }

  // Google Drive (view / preview / open / uc)
  if (url.includes("drive.google.com")) {
    const id =
      (url.match(/\/d\/([^/]+)/) || url.match(/id=([^&]+)/))?.[1];
    if (!id) return null;

    return {
      src: `https://drive.google.com/uc?export=download&id=${id}`,
      type: "video/mp4"
    };
  }

  // Direct MP4
  return { src: url, type: "video/mp4" };
}

/* ===============================
   EPISODES
================================ */
let currentEpisode = 0;
const storageKey = `resume_${seriesId}`;
const episodesDiv = document.getElementById("episodes");

serie.episodes.forEach((ep, i) => {
  const b = document.createElement("button");
  b.textContent = ep.title;
  b.onclick = () => loadEpisode(i, true);
  episodesDiv.appendChild(b);
});

function loadEpisode(index, userAction=false) {
  const ep = serie.episodes[index];
  const video = normalizeVideo(ep.video);
  if (!video) return;

  currentEpisode = index;

  player.src(video);
  player.load();

  localStorage.setItem(storageKey, JSON.stringify({
    episode: index,
    time: 0
  }));

  if (userAction && userHasActivePIN()) {
    player.requestFullscreen();
  }

  player.play().catch(()=>{});
}

/* ===============================
   RESUME
================================ */
const saved = JSON.parse(localStorage.getItem(storageKey));
if (saved && serie.episodes[saved.episode]) {
  loadEpisode(saved.episode);
  player.one("loadedmetadata", () => {
    player.currentTime(saved.time || 0);
  });
}

player.on("timeupdate", () => {
  const data = JSON.parse(localStorage.getItem(storageKey)) || {};
  data.time = player.currentTime();
  localStorage.setItem(storageKey, JSON.stringify(data));
});

player.on("ended", () => {
  const next = currentEpisode + 1;
  if (serie.episodes[next]) loadEpisode(next);
});

/* ===============================
   CONTROLS
================================ */
watchNowBtn.onclick = () => loadEpisode(saved?.episode || 0, true);
nextEpisodeBtn.onclick = () =>
  serie.episodes[currentEpisode+1] && loadEpisode(currentEpisode+1,true);
prevEpisodeBtn.onclick = () =>
  serie.episodes[currentEpisode-1] && loadEpisode(currentEpisode-1,true);

toggleEpisodesBtn.onclick = () => {
  episodesDiv.style.display =
    episodesDiv.style.display === "none" ? "block" : "none";
};

shareBtn.onclick = () => {
  const text = encodeURIComponent(
    `${serie.title}\n\n${serie.synopsis}\n\nWatch üëâ https://bit.ly/busanso`
  );
  window.open(`https://api.whatsapp.com/send?text=${text}`);
};

/* ===============================
   PIN CHECK (UNCHANGED)
================================ */
function userHasActivePIN() {
  return window.ACTIVE_PIN === true;
}

/* ===============================
   COMMENTS
================================ */
submitComment.onclick = () => {
  const v = commentInput.value.trim();
  if (!v) return;
  const d = document.createElement("div");
  d.textContent = v;
  commentList.appendChild(d);
  commentInput.value = "";
};
</script>
</body>
</html>
