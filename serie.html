<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Series</title>

<!-- OpenGraph -->
<meta property="og:type" content="website">
<meta property="og:site_name" content="BUSANSO NATION">
<meta property="og:title" content="">
<meta property="og:description" content="">
<meta property="og:image" content="">
<meta property="og:url" content="https://bit.ly/busanso">

<!-- Video.js -->
<link href="https://vjs.zencdn.net/8.11.2/video-js.css" rel="stylesheet">

<!-- Plyr -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css"/>

<style>
body {margin:0; background:#000; color:#fff; font-family:Arial,sans-serif;}
.container{max-width:1100px; margin:auto; padding:12px;}
.player-wrapper{position:relative; width:100%; aspect-ratio:16/9; background:#000;}
video, iframe{width:100%; height:100%; border:0;}
.hidden{display:none;}
button{padding:12px 18px; font-size:15px; border:none; border-radius:6px; margin:6px 6px 6px 0; cursor:pointer;}
.primary{background:#e50914;color:#fff;}
.secondary{background:#333;color:#fff;}
.nav{background:#1db954;color:#fff;}
#episodes button{width:100%;margin:4px 0;}
.comment-box textarea{width:100%;height:70px;background:#111;color:#fff;border:1px solid #333;border-radius:4px;padding:6px;}
</style>
</head>

<body>
<div class="container">

<div class="player-wrapper">
  <!-- Video.js for MP4/HLS -->
  <video id="vjsPlayer" class="video-js vjs-big-play-centered" controls playsinline></video>

  <!-- Iframe for YouTube/Vimeo (via Plyr) -->
  <iframe id="iframePlayer" class="hidden" allow="autoplay; fullscreen"></iframe>

  <!-- Google Drive iframe fallback -->
  <iframe id="drivePlayer" class="hidden" allow="autoplay; fullscreen"></iframe>
</div>

<div>
  <button id="prevEpisodeBtn" class="nav">‚èÆ Previous</button>
  <button id="nextEpisodeBtn" class="nav">‚è≠ Next</button>
</div>

<h2 id="seriesTitle"></h2>
<p id="seriesMeta"></p>
<p id="seriesSynopsis"></p>

<button id="watchNowBtn" class="primary">‚ñ∂ Watch Now</button>
<button id="toggleEpisodesBtn" class="secondary">Show / Hide Episodes</button>
<button id="shareBtn" class="secondary">üì§ Share</button>

<div id="episodes"></div>

<div class="comment-box">
  <textarea id="commentInput" placeholder="Add a comment..."></textarea>
  <button id="submitComment" class="primary">Submit</button>
  <div id="commentList"></div>
</div>

</div>

<!-- Data & logic files -->
<script src="series-data.js"></script>
<script src="auth.js"></script>
<script src="pins.js"></script>
<script src="ads.js"></script>

<!-- Video.js + YouTube plugin -->
<script src="https://vjs.zencdn.net/8.11.2/video.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/videojs-youtube@2.6.1/dist/Youtube.min.js"></script>

<!-- Plyr -->
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<script>
/* ================= SERIES LOAD ================= */
const params = new URLSearchParams(location.search);
const seriesId = params.get("id");
const serie = SERIES.find(s=>s.id===seriesId);
if(!serie) location.replace("series.html");

seriesTitle.textContent = serie.title;
seriesMeta.textContent = `${serie.genre} ‚Ä¢ ${serie.country} ‚Ä¢ ${serie.year}`;
seriesSynopsis.textContent = serie.synopsis || "";

document.querySelector('meta[property="og:title"]').content = serie.title;
document.querySelector('meta[property="og:description"]').content = serie.synopsis || "";
document.querySelector('meta[property="og:image"]').content = serie.poster;

/* ================= PLAYERS ================= */
const vjs = videojs("vjsPlayer",{autoplay:false, controls:true, fluid:true, techOrder:['youtube','html5']});
const plyrFrame = document.getElementById("iframePlayer");
const driveFrame = document.getElementById("drivePlayer");
let currentEpisode = 0;
const storageKey = `resume_${seriesId}`;

function hideAllPlayers(){
  vjs.pause();
  vjs.el().classList.add("hidden");
  plyrFrame.classList.add("hidden");
  driveFrame.classList.add("hidden");
}

/* ================= HELPERS ================= */
function detectType(url){
  if(!url) return "mp4";
  if(/youtu\.?be/.test(url)) return "youtube";
  if(url.includes("vimeo.com")) return "vimeo";
  if(url.includes("drive.google.com")) return "drive";
  return "mp4";
}

function normalizeYouTube(url){
  const id = (url.match(/v=([^&]+)/) || url.match(/youtu\.be\/([^?]+)/))?.[1];
  return `https://www.youtube.com/embed/${id}?autoplay=1`;
}

function normalizeVimeo(url){
  const id = url.match(/vimeo\.com\/(\d+)/)?.[1];
  return `https://player.vimeo.com/video/${id}?autoplay=1`;
}

function normalizeDrive(url){
  const id = (url.match(/\/d\/([^/]+)/) || url.match(/id=([^&]+)/))?.[1];
  return `https://drive.google.com/file/d/${id}/preview`;
}

/* ================= LOAD EPISODE ================= */
function loadEpisode(index, userAction=false){
  const ep = serie.episodes[index];
  currentEpisode = index;
  hideAllPlayers();

  const type = detectType(ep.video);

  if(type === "youtube"){
    plyrFrame.src = normalizeYouTube(ep.video);
    plyrFrame.classList.remove("hidden");
  }
  else if(type === "vimeo"){
    plyrFrame.src = normalizeVimeo(ep.video);
    plyrFrame.classList.remove("hidden");
  }
  else if(type === "drive"){
    driveFrame.src = normalizeDrive(ep.video);
    driveFrame.classList.remove("hidden");
  }
  else{
    vjs.el().classList.remove("hidden");
    vjs.src({src: ep.video, type: "video/mp4"});
    vjs.play().catch(()=>{
      // fallback silently to iframe player if Video.js fails
      if(ep.video.includes("youtu")) plyrFrame.src = normalizeYouTube(ep.video), plyrFrame.classList.remove("hidden");
      else if(ep.video.includes("drive.google.com")) driveFrame.src = normalizeDrive(ep.video), driveFrame.classList.remove("hidden");
    });
  }

  localStorage.setItem(storageKey, JSON.stringify({episode:index, time:0}));

  if(userAction && userHasActivePIN()){
    const el = !vjs.el().classList.contains("hidden")?vjs.el():
               !plyrFrame.classList.contains("hidden")?plyrFrame:driveFrame;
    el.requestFullscreen?.();
  }
}

/* ================= RESUME ================= */
const saved = JSON.parse(localStorage.getItem(storageKey));
if(saved && serie.episodes[saved.episode]){
  loadEpisode(saved.episode);
  vjs.one("loadedmetadata",()=>vjs.currentTime(saved.time||0));
}

vjs.on("timeupdate", ()=>{
  const data = JSON.parse(localStorage.getItem(storageKey))||{};
  data.time = vjs.currentTime();
  localStorage.setItem(storageKey, JSON.stringify(data));
});

vjs.on("ended", ()=>{
  if(serie.episodes[currentEpisode+1]) loadEpisode(currentEpisode+1);
});

/* ================= UI ================= */
serie.episodes.forEach((ep,i)=>{
  const b = document.createElement("button");
  b.textContent = ep.title;
  b.onclick = ()=>loadEpisode(i,true);
  episodes.appendChild(b);
});

watchNowBtn.onclick = ()=>loadEpisode(saved?.episode||0,true);
nextEpisodeBtn.onclick = ()=>serie.episodes[currentEpisode+1]&&loadEpisode(currentEpisode+1,true);
prevEpisodeBtn.onclick = ()=>serie.episodes[currentEpisode-1]&&loadEpisode(currentEpisode-1,true);
toggleEpisodesBtn.onclick = ()=>episodes.style.display = episodes.style.display==="none"?"block":"none";
shareBtn.onclick = ()=>{
  const t=encodeURIComponent(`${serie.title}\n\n${serie.synopsis}\n\nWatch üëâ https://bit.ly/busanso`);
  window.open(`https://api.whatsapp.com/send?text=${t}`);
};

function userHasActivePIN(){return window.ACTIVE_PIN===true;}

submitComment.onclick=()=>{
  if(!commentInput.value.trim()) return;
  const d=document.createElement("div");
  d.textContent = commentInput.value;
  commentList.appendChild(d);
  commentInput.value="";
};
</script>
</body>
</html>
