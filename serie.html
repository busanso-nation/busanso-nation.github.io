<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Series</title>

<!-- OpenGraph -->
<meta property="og:type" content="website">
<meta property="og:site_name" content="BUSANSO NATION">
<meta property="og:title" content="">
<meta property="og:description" content="">
<meta property="og:image" content="">
<meta property="og:url" content="https://bit.ly/busanso">

<!-- Plyr CSS -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #000;
  color: #fff;
}
.container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 12px;
}
.player-area { width: 100%; }
#player { width: 100%; height: 560px; background: #000; }

/* Buttons styling */
button {
  padding: 14px 20px;
  font-size: 16px;
  border: none;
  cursor: pointer;
  margin: 6px 6px 6px 0;
  border-radius: 6px;
  transition: 0.2s;
}
button:hover { opacity: 0.85; }
button.primary { background: #e50914; color: #fff; }
button.secondary { background: #333; color: #fff; }
button.nav { background: #1db954; color: #fff; }

/* Episode buttons */
#episodes button { display: block; width: 100%; margin: 4px 0; }

/* Comment box */
.comment-box { margin-top: 20px; }
.comment-box input, .comment-box textarea {
  font-size: 14px;
  border-radius: 5px;
  border: 1px solid #333;
  background:#111;
  color:#fff;
  padding: 6px;
  margin-bottom: 6px;
}
.comment-box button.primary { font-size: 16px; padding: 10px 18px; border-radius: 6px; }
.comment { padding: 8px 6px; border-bottom: 1px solid #333; position: relative; }
.comment strong { color:#1db954; }
.comment span { color:#888; font-size:12px; margin-left: 6px; }
</style>
</head>
<body>

<div class="container">

  <!-- PLAYER AREA -->
  <div class="player-area" id="playerContainer">
    <video id="player" controls crossorigin></video>
  </div>

  <!-- Next / Previous episode buttons -->
  <div class="nav-episodes">
    <button id="prevEpisodeBtn" class="nav">‚èÆ Previous Episode</button>
    <button id="nextEpisodeBtn" class="nav">‚è≠ Next Episode</button>
  </div>

  <!-- SERIES INFO & CONTROLS BELOW -->
  <h2 id="seriesTitle"></h2>
  <p id="seriesMeta"></p>
  <p id="seriesSynopsis"></p>

  <button id="watchNowBtn" class="primary">‚ñ∂ Watch Now</button>
  <button id="toggleEpisodesBtn" class="secondary">Show/Hide Episodes</button>
  <button id="shareBtn" class="secondary">üì§ Share WhatsApp</button>

  <div id="episodes"></div>

  <!-- Comment Section -->
  <div class="comment-box">
    <input id="usernameInput" placeholder="Your nickname">
    <textarea id="commentInput" placeholder="Add a comment..."></textarea>
    <button id="commentBtn" class="primary">Submit Comment</button>
    <div id="commentsList"></div>
  </div>

</div>

<!-- Series Data -->
<script src="series-data.js"></script>

<!-- Ads & Auth / PIN Logic -->
<script src="auth.js"></script>
<script src="pins.js"></script>
<script src="ads.js"></script>

<!-- Plyr -->
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* Firebase config */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_MSG_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script>
/* ===============================
   SERIES & PLAYER LOGIC
================================ */
const params = new URLSearchParams(location.search);
const seriesId = params.get("id");
const serie = SERIES.find(s => s.id === seriesId);
if (!serie) location.replace("series.html");

// Populate text
seriesTitle.textContent = serie.title;
seriesMeta.textContent = `${serie.genre} ‚Ä¢ ${serie.country} ‚Ä¢ ${serie.year}`;
seriesSynopsis.textContent = serie.synopsis || "";

// OG tags
document.querySelector('meta[property="og:title"]').content = serie.title;
document.querySelector('meta[property="og:description"]').content = serie.synopsis || "";
document.querySelector('meta[property="og:image"]').content = serie.poster;

/* Plyr player setup */
const player = new Plyr('#player', { autoplay:false, controls:['play','progress','current-time','mute','volume','fullscreen'] });
const storageKey = `resume_${seriesId}`;
let currentEpisode = 0;

// Episode buttons
const episodesContainer = document.getElementById('episodes');
serie.episodes.forEach((ep,index)=>{
  const btn = document.createElement("button");
  btn.textContent = ep.title;
  btn.onclick = ()=>{ loadEpisode(index,true); scrollToPlayer(); };
  episodesContainer.appendChild(btn);
});

// Scroll to player
function scrollToPlayer(){ document.getElementById('playerContainer').scrollIntoView({behavior:'smooth',block:'start'}); }

// Load episode
function loadEpisode(index,userAction=false){
  const ep = serie.episodes[index]; currentEpisode=index;
  if(ep.video.includes("youtube")||ep.video.includes("youtu.be")){
    player.source={type:'video',sources:[{src:ep.video,provider:'youtube'}]};
  } else if(ep.video.includes("vimeo")){
    player.source={type:'video',sources:[{src:ep.video,provider:'vimeo'}]};
  } else {
    player.source={type:'video',sources:[{src:ep.video,type:'video/mp4'}]};
  }
  localStorage.setItem(storageKey,JSON.stringify({episode:index,time:0}));
  if(userAction && userHasActivePIN()) player.fullscreen.enter();
  player.play();
}

// Auto-resume
const saved = JSON.parse(localStorage.getItem(storageKey));
if(saved && serie.episodes[saved.episode]){ loadEpisode(saved.episode); player.currentTime=saved.time||0; }

// Save playback time
player.on('timeupdate',()=>{ 
  const current=JSON.parse(localStorage.getItem(storageKey))||{}; 
  current.time=player.currentTime; 
  localStorage.setItem(storageKey,JSON.stringify(current));
});

// Auto-next
player.on('ended',()=>{ const next=currentEpisode+1; if(serie.episodes[next]) loadEpisode(next); });

// Watch Now
watchNowBtn.onclick=()=>{ const startEp=saved?.episode||0; loadEpisode(startEp,true); scrollToPlayer(); };

// Next/Previous
nextEpisodeBtn.onclick=()=>{ const next=currentEpisode+1; if(serie.episodes[next]){ loadEpisode(next,true); scrollToPlayer(); } };
prevEpisodeBtn.onclick=()=>{ const prev=currentEpisode-1; if(serie.episodes[prev]){ loadEpisode(prev,true); scrollToPlayer(); } };

// Toggle episodes
let episodesVisible=true;
toggleEpisodesBtn.onclick=()=>{ episodesVisible=!episodesVisible; episodesContainer.style.display=episodesVisible?'block':'none'; };

// Share WhatsApp
shareBtn.onclick=()=>{ const text=encodeURIComponent(`${serie.title}\n\n${serie.synopsis}\n\nWatch üëâ https://bit.ly/busanso`);
window.open(`https://api.whatsapp.com/send?text=${text}`,'_blank'); };

// Dummy auth
function userHasActivePIN(){ return window.ACTIVE_PIN===true; }

/* ===============================
   COMMENT LOGIC (Firebase)
================================ */
const usernameInput=document.getElementById("usernameInput");
const commentInput=document.getElementById("commentInput");
const commentBtnEl=document.getElementById("commentBtn");
const commentsList=document.getElementById("commentsList");

// Load saved username
const savedUsername=localStorage.getItem("username");
if(savedUsername) usernameInput.value=savedUsername;

// Firebase ref per series
const commentsRef=db.ref("comments/"+seriesId);

// Submit comment
commentBtnEl.onclick=function(){
  var user=usernameInput.value.trim().slice(0,20);
  var text=commentInput.value.trim().slice(0,300);
  if(!user||!text) return;
  localStorage.setItem("username",user);
  commentsRef.push({user:user,text:text,timestamp:firebase.database.ServerValue.TIMESTAMP});
  commentInput.value="";
};

// Load last 100 comments, newest first
commentsRef.limitToLast(100).on("value",function(snap){
  commentsList.innerHTML="";
  var arr=[];
  snap.forEach(function(c){ arr.push({data:c.val(),ref:c.ref}); });
  arr.sort(function(a,b){ return b.data.timestamp-a.data.timestamp; });
  arr.forEach(function(c){
    var div=document.createElement("div");
    div.className="comment"; div.style.position="relative";
    div.innerHTML=`<strong>${c.data.user}</strong>: ${c.data.text} <span style="float:right; color:#888; font-size:12px;">${new Date(c.data.timestamp).toLocaleString()}</span>`;
    if(localStorage.getItem("activePIN")==="Orion196"){
      var b=document.createElement("button");
      b.textContent="üóë"; b.style.position="absolute"; b.style.right="6px"; b.style.top="6px";
      b.style.background="#e50914"; b.style.color="#fff"; b.style.border="none"; b.style.borderRadius="3px"; b.style.padding="2px 6px"; b.style.cursor="pointer";
      b.onclick=function(){ c.ref.remove(); };
      div.appendChild(b);
    }
    commentsList.appendChild(div);
  });
});
</script>

</body>
</html>
