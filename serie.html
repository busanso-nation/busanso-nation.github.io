<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Watch Series</title>

<!-- OpenGraph (WhatsApp preview) -->
<meta property="og:type" content="website">
<meta property="og:site_name" content="BUSANSO NATION">
<meta property="og:title" content="">
<meta property="og:description" content="">
<meta property="og:image" content="">
<meta property="og:url" content="https://bit.ly/busanso">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #000;
  color: #fff;
}

.container {
  display: flex;
  gap: 16px;
  padding: 12px;
}

.player-area {
  flex: 2;
}

.sidebar {
  flex: 1;
  max-width: 320px;
}

/* WIDESCREEN MODE (paid users only) */
body.wide-player .container {
  flex-direction: column;
}

body.wide-player .sidebar {
  display: none;
}

iframe {
  width: 100%;
  height: 420px;
  border: none;
}

button {
  padding: 10px 14px;
  background: #e50914;
  border: none;
  color: #fff;
  cursor: pointer;
}

button.secondary {
  background: #333;
}
</style>
</head>

<body>

<div class="container">

  <!-- PLAYER -->
  <div class="player-area">
    <iframe id="videoPlayer" allowfullscreen allow="autoplay"></iframe>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2 id="seriesTitle"></h2>
    <p id="seriesMeta"></p>
    <p id="seriesSynopsis"></p>

    <button id="watchNowBtn">â–¶ Watch Now</button>
    <button id="shareBtn" class="secondary">ðŸ“¤ Share WhatsApp</button>

    <div id="episodes"></div>

    <!-- YOUR ADS BLOCK (UNCHANGED) -->
    <!-- keep your ad container + logic here -->
  </div>

</div>

<!-- SERIES DATA -->
<script src="series-data.js"></script>

<!-- ===============================
     ðŸ”’ YOUR EXISTING LOGIC SCRIPTS
     DO NOT MODIFY THEM
================================ -->
<script src="auth.js"></script>
<script src="pins.js"></script>
<script src="ads.js"></script>
<!-- =============================== -->

<script>
/* ===============================
   SAFE ADD-ONS (NO LOGIC TOUCHED)
================================ */

const params = new URLSearchParams(location.search);
const seriesId = params.get("id");

const serie = SERIES.find(s => s.id === seriesId);
if (!serie) location.replace("series.html");

// Populate text
seriesTitle.textContent = serie.title;
seriesMeta.textContent = `${serie.genre} â€¢ ${serie.country} â€¢ ${serie.year}`;
seriesSynopsis.textContent = serie.synopsis || "";

// OG tags for WhatsApp
document.querySelector('meta[property="og:title"]').content = serie.title;
document.querySelector('meta[property="og:description"]').content = serie.synopsis || "";
document.querySelector('meta[property="og:image"]').content = serie.poster;

// Build episodes
serie.episodes.forEach((ep, index) => {
  const btn = document.createElement("button");
  btn.textContent = ep.title;
  btn.onclick = () => loadEpisode(index, true);
  episodes.appendChild(btn);
});

// STORAGE KEYS
const storageKey = `resume_${seriesId}`;

// Load episode
function loadEpisode(index, userAction = false) {
  const ep = serie.episodes[index];
  videoPlayer.src = ep.video;

  localStorage.setItem(storageKey, JSON.stringify({
    episode: index,
    time: 0
  }));

  if (userAction && userHasActivePIN()) {
    document.body.classList.add("wide-player");
  }
}

// Auto-resume
const saved = JSON.parse(localStorage.getItem(storageKey));
if (saved && serie.episodes[saved.episode]) {
  loadEpisode(saved.episode);
}

// Watch Now button
watchNowBtn.onclick = () => {
  const startEp = saved?.episode || 0;
  loadEpisode(startEp, true);
};

// Share WhatsApp
shareBtn.onclick = () => {
  const text = encodeURIComponent(
    `${serie.title}\n\n${serie.synopsis}\n\nWatch ðŸ‘‰ https://bit.ly/busanso`
  );
  window.open(`https://api.whatsapp.com/send?text=${text}`, "_blank");
};

/* ===============================
   PLAYER PROVIDER HANDLING
================================ */

// YouTube API
let ytPlayer;
function onYouTubeIframeAPIReady() {
  ytPlayer = new YT.Player("videoPlayer", {
    events: {
      onStateChange: e => {
        if (e.data === YT.PlayerState.ENDED) autoNext();
        if (e.data === YT.PlayerState.PLAYING) saveYTTime();
      }
    }
  });
}

function saveYTTime() {
  if (!ytPlayer) return;
  const data = JSON.parse(localStorage.getItem(storageKey));
  if (!data) return;
  data.time = ytPlayer.getCurrentTime();
  localStorage.setItem(storageKey, JSON.stringify(data));
}

function autoNext() {
  const data = JSON.parse(localStorage.getItem(storageKey));
  if (!data) return;
  const next = data.episode + 1;
  if (serie.episodes[next]) loadEpisode(next);
}

// Load YT API only if needed
if (serie.episodes.some(e => e.video.includes("youtube"))) {
  const tag = document.createElement("script");
  tag.src = "https://www.youtube.com/iframe_api";
  document.body.appendChild(tag);
}

// Dummy checker (uses your existing auth logic)
function userHasActivePIN() {
  return window.ACTIVE_PIN === true;
}
</script>

</body>
</html>
