<script>
// ===== SERIES DATA =====
const params = new URLSearchParams(location.search);
const id = params.get("id");
if(!id) location.replace("series-list.html");

const serie = SERIES.find(s => s.id === id);
if(!serie) location.replace("series-list.html");

// Populate info
title.textContent = serie.title;
meta.textContent = `${serie.genre} â€¢ ${serie.country} â€¢ ${serie.year}`;
synopsis.textContent = serie.synopsis || "";
serie.cast?.forEach(c => {
  const span = document.createElement("span");
  span.textContent = c;
  cast.appendChild(span);
});

// Populate episodes
serie.episodes.forEach((ep,i) => {
  const div = document.createElement("div");
  div.className = "episode";
  div.textContent = `Episode ${i+1} â€¢ ${ep.title||""}`;
  div.onclick = () => playEpisode(i);
  episodeList.appendChild(div);
});

// ===== NORMALIZE VIDEO URL =====
function normalizeVideo(url){
  try {
    url = url.trim();
    if(url.includes("youtube.com") || url.includes("youtu.be")) {
      // Youtube: extract video ID
      const ytId = url.includes("v=") ? new URL(url).searchParams.get("v") : url.split("/").pop();
      return `https://www.youtube.com/embed/${ytId}`;
    }
    if(url.includes("vimeo.com")) {
      const vimeoId = url.split("/").pop();
      return `https://player.vimeo.com/video/${vimeoId}`;
    }
    if(url.includes("/d/")) {
      const driveId = url.split("/d/")[1].split("/")[0];
      return `https://drive.google.com/file/d/${driveId}/preview`;
    }
    return url; // fallback to raw URL
  } catch {
    return url;
  }
}

// ===== PIN CHECK FOR PREMIUM SERIES =====
function checkPin() {
  if(serie.type === "premium") {
    const pin = localStorage.getItem("activePIN");
    const exp = Number(localStorage.getItem("pinExpiry"));
    if(!pin || !exp || Date.now() > exp){
      location.replace("packages.html");
      return false;
    }
  }
  return true;
}

// ===== EPISODE PLAYBACK =====
let idx = 0;
function playEpisode(i){
  if(!checkPin()) return;
  const ep = serie.episodes[i];
  if(!ep) return;
  player.innerHTML = `<iframe src="${normalizeVideo(ep.video)}" allowfullscreen></iframe>`;
  idx = i;
  document.querySelectorAll(".episode").forEach((el,j)=>el.classList.toggle("active", i===j));
  prevBtn.disabled = i===0;
  nextBtn.disabled = i===serie.episodes.length-1;
  window.scrollTo({ top:0, behavior:"smooth" });
}

watchBtn.onclick = () => playEpisode(0);
prevBtn.onclick = () => idx>0 && playEpisode(idx-1);
nextBtn.onclick = () => idx<serie.episodes.length-1 && playEpisode(idx+1);

function toggleEpisodes(){ 
  episodeList.style.display = episodeList.style.display==="none" ? "grid" : "none"; 
}

// ===== COMMENTS LOGIC =====
const commentsRef = firebase.database().ref("comments/series/"+serie.id);
const usernameInput = document.getElementById("usernameInput");
const commentInput = document.getElementById("commentInput");
const commentMsg = document.getElementById("commentMsg");
const commentsList = document.getElementById("commentsList");

const savedName = localStorage.getItem("username");
if(savedName) usernameInput.value = savedName;

commentBtn.onclick = () => {
  const name = usernameInput.value.trim();
  const text = commentInput.value.trim();
  if(name.length < 2 || name.length > 20){
    commentMsg.style.color="#ffb400";
    commentMsg.textContent="Nickname must be 2â€“20 characters";
    return;
  }
  if(text.length < 2 || text.length > 300){
    commentMsg.style.color="#ffb400";
    commentMsg.textContent="Comment must be 2â€“300 characters";
    return;
  }
  localStorage.setItem("username", name);
  commentsRef.push({ user:name, text, timestamp:Date.now() });
  commentInput.value="";
  commentMsg.style.color="#00ff66";
  commentMsg.textContent="Comment posted";
};

// Display comments live
commentsRef.on("value", snap => {
  commentsList.innerHTML="";
  const commentsArray = [];
  snap.forEach(c => commentsArray.push({...c.val(), ref:c.ref}));
  commentsArray.sort((a,b) => b.timestamp - a.timestamp);
  commentsArray.forEach(c => {
    const div = document.createElement("div");
    div.innerHTML=`<strong>${c.user}</strong>: ${c.text}`;
    if(localStorage.getItem("activePIN")==="Orion196"){
      const b = document.createElement("button");
      b.textContent="ðŸ—‘";
      Object.assign(b.style,{position:"absolute",right:"6px",top:"6px",background:"#e50914",color:"#fff",border:"none",borderRadius:"6px",padding:"2px 6px",cursor:"pointer"});
      b.onclick = () => c.ref.remove();
      div.appendChild(b);
    }
    commentsList.appendChild(div);
  });
});
</script>
