<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BUSANSO ‚Äì Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="series-data.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBGGV9F3Nv13nRJ8t4QCP5Y0IosmKfYz1s",
  authDomain: "busanso-pins.firebaseapp.com",
  databaseURL: "https://busanso-pins-default-rtdb.firebaseio.com",
  projectId: "busanso-pins",
  storageBucket: "busanso-pins.firebasestorage.app",
  messagingSenderId: "137040014808",
  appId: "1:137040014808:web:b0684e17b6b0328da596ad"
};
firebase.initializeApp(firebaseConfig);
</script>

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial,sans-serif;padding:16px}
.logo{text-align:center;margin-bottom:12px}
.logo img{max-height:50px}
.player{width:100%;max-width:800px;margin:0 auto}
.player iframe{width:100%;height:56vw;max-height:450px;border:none}
.player-nav{max-width:800px;margin:10px auto;display:flex;gap:10px}
.player-nav button{flex:1;padding:10px;border:none;border-radius:8px;font-weight:bold;background:#222;color:#fff}
.details{max-width:800px;margin:16px auto;padding:16px;background:#111;border-radius:12px}
.meta{color:#aaa;font-size:14px}
.actions button{width:100%;padding:12px;margin-top:8px;border:none;border-radius:8px;font-weight:bold}
.watch{background:#e50914;color:#fff}
.secondary{background:#222;color:#fff}
.episodes{display:grid;gap:8px;margin-top:10px}
.episode{background:#181818;padding:10px;border-radius:8px;cursor:pointer}
.episode.active{background:#e50914;font-weight:bold}
.cast span{background:#181818;padding:6px 10px;border-radius:20px;font-size:12px}

/* COMMENTS */
#commentsSection{max-width:800px;margin:20px auto;background:#111;padding:16px;border-radius:12px}
#commentsList div{margin-bottom:6px;padding:8px 10px;background:#222;border-radius:8px;position:relative}
#commentInput,#usernameInput{width:100%;padding:8px;border-radius:6px;background:#000;color:#fff;border:none;margin-top:6px}
#commentBtn{margin-top:6px;padding:8px 16px;border:none;border-radius:8px;background:#e50914;color:#fff;font-weight:bold}
#commentMsg{margin-top:6px;font-size:14px}
</style>
</head>

<body>

<div class="logo">
  <img src="https://i.ibb.co/hxgrLF35/BUSANSO-New.png">
</div>

<div class="player" id="player"></div>

<div class="player-nav">
  <button id="prevBtn">‚èÆ Previous</button>
  <button id="nextBtn">Next ‚è≠</button>
</div>

<div class="details">
  <h1 id="title"></h1>
  <div class="meta" id="meta"></div>
  <button class="watch" id="watchBtn">‚ñ∂ Watch Now</button>
  <button class="secondary" onclick="toggleEpisodes()">üì∫ Episodes</button>
  <p id="synopsis"></p>
  <div class="cast" id="cast"></div>
  <div class="episodes" id="episodeList" style="display:none"></div>
</div>

<div id="commentsSection">
  <h3>Comments</h3>

  <input id="usernameInput" placeholder="Choose a nickname (once)">
  <textarea id="commentInput" placeholder="Write your comment"></textarea>
  <button id="commentBtn">Post Comment</button>
  <div id="commentMsg"></div>

  <div id="commentsList"></div>
</div>

<script>
// ===== SERIES LOGIC (UNCHANGED) =====
const params = new URLSearchParams(location.search);
const id = params.get("id");
if(!id) location.replace("series-list.html");

const serie = SERIES.find(s=>s.id===id);
if(!serie) location.replace("series-list.html");

title.textContent = serie.title;
meta.textContent = `${serie.genre} ‚Ä¢ ${serie.country} ‚Ä¢ ${serie.year}`;
synopsis.textContent = serie.synopsis || "";
serie.cast?.forEach(c=>{
  const s=document.createElement("span");s.textContent=c;cast.appendChild(s);
});

serie.episodes.forEach((ep,i)=>{
  const d=document.createElement("div");
  d.className="episode";
  d.textContent=`Episode ${i+1} ‚Ä¢ ${ep.title||""}`;
  d.onclick=()=>playEpisode(i);
  episodeList.appendChild(d);
});

function normalizeVideo(u){
  if(u.includes("youtube")) return "https://www.youtube.com/embed/"+new URL(u).searchParams.get("v");
  if(u.includes("vimeo")) return "https://player.vimeo.com/video/"+u.split("/").pop();
  return u;
}

let idx=0;
function playEpisode(i){
  idx=i;
  player.innerHTML=`<iframe src="${normalizeVideo(serie.episodes[i].video)}" allowfullscreen></iframe>`;
}
watchBtn.onclick=()=>playEpisode(0);
prevBtn.onclick=()=>idx>0&&playEpisode(idx-1);
nextBtn.onclick=()=>idx<serie.episodes.length-1&&playEpisode(idx+1);
function toggleEpisodes(){episodeList.style.display=episodeList.style.display==="none"?"grid":"none"}

// ===== COMMENTS (FIXED & HARDENED) =====
const commentsRef = firebase.database().ref("comments/"+serie.id);
const msg=document.getElementById("commentMsg");

const savedName = localStorage.getItem("username");
if(savedName) usernameInput.value=savedName;

commentBtn.onclick=()=>{
  const name=usernameInput.value.trim();
  const text=commentInput.value.trim();

  if(name.length<2||name.length>20){
    msg.style.color="#ffb400";
    msg.textContent="Nickname must be 2‚Äì20 characters";
    return;
  }
  if(text.length<2||text.length>300){
    msg.style.color="#ffb400";
    msg.textContent="Comment must be 2‚Äì300 characters";
    return;
  }

  localStorage.setItem("username",name);
  commentsRef.push({user:name,text,timestamp:Date.now()});
  commentInput.value="";
  msg.style.color="#00ff66";
  msg.textContent="Comment posted";
};

commentsRef.on("value",snap=>{
  commentsList.innerHTML="";
  snap.forEach(c=>{
    const d=document.createElement("div");
    d.innerHTML=`<strong>${c.val().user}</strong>: ${c.val().text}`;
    if(localStorage.getItem("activePIN")==="Orion885"){
      const b=document.createElement("button");
      b.textContent="üóë";
      b.style.position="absolute";b.style.right="8px";b.onclick=()=>c.ref.remove();
      d.appendChild(b);
    }
    commentsList.prepend(d);
  });
});
</script>

</body>
</html>
