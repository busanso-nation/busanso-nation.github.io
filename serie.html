<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Series</title>
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<style>
body { margin:0; font-family:Arial,sans-serif; background:#000; color:#fff; }
.container { max-width:1200px; margin:0 auto; padding:12px; }
.player-area { width:100%; position:relative; padding-top:56.25%; }
#player { position:absolute; top:0; left:0; width:100%; height:100%; }

/* Buttons */
button { padding:12px 18px; font-size:16px; border:none; cursor:pointer; margin:6px 6px 6px 0; border-radius:6px; transition:0.2s; }
button:hover { opacity:0.85; }
button.primary { background:#e50914; color:#fff; }
button.secondary { background:#333; color:#fff; }
button.nav { background:#1db954; color:#fff; }

/* Episode buttons */
#episodes button { display:block; width:100%; margin:4px 0; }

/* Comments */
.comment-box { margin-top:20px; }
.comment-box input, .comment-box textarea { font-size:14px; border-radius:5px; border:1px solid #333; background:#111; color:#fff; padding:6px; margin-bottom:6px; width:100%; }
.comment-box button.primary { font-size:16px; padding:10px 18px; border-radius:6px; }
.comment { padding:8px 6px; border-bottom:1px solid #333; position:relative; }
.comment strong { color:#1db954; }
.comment span { color:#888; font-size:12px; margin-left:6px; }
</style>
</head>
<body>

<div class="container">

  <!-- PLAYER -->
  <div class="player-area">
    <div id="player"></div>
  </div>

  <!-- Navigation -->
  <div class="nav-episodes">
    <button id="prevEpisodeBtn" class="nav">‚èÆ Previous Episode</button>
    <button id="nextEpisodeBtn" class="nav">‚è≠ Next Episode</button>
  </div>

  <!-- Info & Controls -->
  <h2 id="seriesTitle"></h2>
  <p id="seriesMeta"></p>
  <p id="seriesSynopsis"></p>

  <button id="watchNowBtn" class="primary">‚ñ∂ Watch Now</button>
  <button id="toggleEpisodesBtn" class="secondary">Show/Hide Episodes</button>
  <button id="shareBtn" class="secondary">üì§ Share WhatsApp</button>
  <div id="episodes"></div>

  <!-- Comments -->
  <div class="comment-box">
    <input id="usernameInput" placeholder="Your nickname">
    <textarea id="commentInput" placeholder="Add a comment..."></textarea>
    <button id="commentBtn" class="primary">Submit Comment</button>
    <div id="commentsList"></div>
  </div>

</div>

<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="series-data.js"></script>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_MSG_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Plyr
const player = new Plyr('#player',{autoplay:true,controls:['play','progress','current-time','mute','volume','fullscreen']});

// Series
const params = new URLSearchParams(location.search);
const seriesId = params.get("id");
const serie = SERIES.find(s=>s.id===seriesId);
if(!serie) location.replace("series.html");

seriesTitle.textContent = serie.title;
seriesMeta.textContent = `${serie.genre} ‚Ä¢ ${serie.country} ‚Ä¢ ${serie.year}`;
seriesSynopsis.textContent = serie.synopsis||"";

// Episodes
const episodesContainer=document.getElementById('episodes');
let currentEpisode=0;
serie.episodes.forEach((ep,index)=>{
  const btn=document.createElement("button");
  btn.textContent=ep.title;
  btn.onclick=()=>{ loadEpisode(index,true); scrollToPlayer(); };
  episodesContainer.appendChild(btn);
});

// Scroll
function scrollToPlayer(){ document.querySelector('.player-area').scrollIntoView({behavior:'smooth',block:'start'}); }

// Normalize URLs
function normalizeVideo(url){
  url=url.trim();
  // YouTube
  if(url.includes("youtube.com")||url.includes("youtu.be")){
    let id="";
    try{
      if(url.includes("youtu.be")) id=url.split("youtu.be/")[1].split(/[?&]/)[0];
      else if(url.includes("/shorts/")) id=url.split("/shorts/")[1].split(/[?&]/)[0];
      else if(url.includes("/embed/")) id=url.split("/embed/")[1].split(/[?&]/)[0];
      else id=new URL(url).searchParams.get("v");
    } catch(e){}
    if(id) return {type:'youtube',source:id};
  }
  // Vimeo
  if(url.includes("vimeo.com")){
    const id=url.split("/").filter(Boolean).pop();
    return {type:'vimeo',source:id};
  }
  // Google Drive
  if(url.includes("drive.google.com")){
    const match=url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if(match&&match[1]) return {type:'mp4',source:`https://drive.google.com/uc?export=media&id=${match[1]}`};
  }
  return {type:'mp4',source:url};
}

// Load episode
const storageKey=`resume_${seriesId}`;
function loadEpisode(index,userAction=false){
  const ep=serie.episodes[index];
  currentEpisode=index;
  const v=normalizeVideo(ep.video);
  let source;
  if(v.type==='youtube') source={type:'youtube',sources:[{src:v.source,provider:'youtube'}]};
  else if(v.type==='vimeo') source={type:'vimeo',sources:[{src:v.source,provider:'vimeo'}]};
  else source={type:'video',sources:[{src:v.source,type:'video/mp4'}]};
  player.source=source;

  const saved=JSON.parse(localStorage.getItem(storageKey))||{};
  if(saved.episode===index&&saved.time) player.currentTime=saved.time;

  if(userAction && userHasActivePIN()) player.fullscreen.enter();
  player.play();

  localStorage.setItem(storageKey,JSON.stringify({episode:index,time:player.currentTime}));
}

// Auto-resume
const saved=JSON.parse(localStorage.getItem(storageKey));
if(saved&&serie.episodes[saved.episode]!==undefined) loadEpisode(saved.episode);
else loadEpisode(0);

// Save time
player.on('timeupdate',()=>{
  const current=JSON.parse(localStorage.getItem(storageKey))||{};
  current.episode=currentEpisode;
  current.time=player.currentTime;
  localStorage.setItem(storageKey,JSON.stringify(current));
});

// Auto-next
player.on('ended',()=>{ const next=currentEpisode+1;if(serie.episodes[next]) loadEpisode(next); });

// Controls
watchNowBtn.onclick=()=>{ loadEpisode(saved?.episode||0,true); scrollToPlayer(); };
nextEpisodeBtn.onclick=()=>{ const next=currentEpisode+1;if(serie.episodes[next]) loadEpisode(next,true); scrollToPlayer(); };
prevEpisodeBtn.onclick=()=>{ const prev=currentEpisode-1;if(serie.episodes[prev]) loadEpisode(prev,true); scrollToPlayer(); };
let episodesVisible=true;
toggleEpisodesBtn.onclick=()=>{ episodesVisible=!episodesVisible; episodesContainer.style.display=episodesVisible?'block':'none'; };
shareBtn.onclick=()=>{
  const text=encodeURIComponent(`${serie.title}\n\n${serie.synopsis}\n\nWatch üëâ https://bit.ly/busanso`);
  window.open(`https://api.whatsapp.com/send?text=${text}`,'_blank');
};

// Dummy PIN
function userHasActivePIN(){ return window.ACTIVE_PIN===true; }

// Comments
const usernameInput=document.getElementById("usernameInput");
const commentInput=document.getElementById("commentInput");
const commentBtnEl=document.getElementById("commentBtn");
const commentsList=document.getElementById("commentsList");
const savedUsername=localStorage.getItem("username");
if(savedUsername) usernameInput.value=savedUsername;
const commentsRef=db.ref("comments/"+seriesId);

commentBtnEl.onclick=function(){
  var user=usernameInput.value.trim().slice(0,20);
  var text=commentInput.value.trim().slice(0,300);
  if(!user||!text) return;
  localStorage.setItem("username",user);
  commentsRef.push({user:user,text:text,timestamp:firebase.database.ServerValue.TIMESTAMP});
  commentInput.value="";
};

commentsRef.limitToLast(100).on("value",snap=>{
  commentsList.innerHTML="";
  var arr=[];
  snap.forEach(c=>{ arr.push({data:c.val(),ref:c.ref}); });
  arr.sort((a,b)=>b.data.timestamp-b.data.timestamp);
  arr.forEach(c=>{
    const div=document.createElement("div");
    div.className="comment"; div.style.position="relative";
    div.innerHTML=`<strong>${c.data.user}</strong>: ${c.data.text} <span style="float:right; color:#888; font-size:12px;">${new Date(c.data.timestamp).toLocaleString()}</span>`;
    if(localStorage.getItem("activePIN")==="Orion196"){
      const b=document.createElement("button");
      b.textContent="üóë"; b.style.position="absolute"; b.style.right="6px"; b.style.top="6px";
      b.style.background="#e50914"; b.style.color="#fff"; b.style.border="none"; b.style.borderRadius="3px"; b.style.padding="2px 6px"; b.style.cursor="pointer";
      b.onclick=function(){ c.ref.remove(); };
      div.appendChild(b);
    }
    commentsList.appendChild(div);
  });
});
</script>

</body>
</html>
