<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Series</title>

<!-- OpenGraph (WhatsApp preview) -->
<meta property="og:type" content="website">
<meta property="og:site_name" content="BUSANSO NATION">
<meta property="og:title" content="">
<meta property="og:description" content="">
<meta property="og:image" content="">
<meta property="og:url" content="https://bit.ly/busanso">

<!-- Plyr CSS -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #000;
  color: #fff;
}
.container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 12px;
}
.player-area {
  width: 100%;
}
#player {
  width: 100%;
  height: 560px;
  background: #000;
}

/* Buttons styling */
button {
  padding: 14px 20px;
  font-size: 16px;
  border: none;
  cursor: pointer;
  margin: 6px 6px 6px 0;
  border-radius: 6px;
  transition: 0.2s;
}
button:hover {
  opacity: 0.85;
}
button.primary {
  background: #e50914;
  color: #fff;
}
button.secondary {
  background: #333;
  color: #fff;
}
button.nav {
  background: #1db954;
  color: #fff;
}

/* Episode buttons */
#episodes button {
  display: block;
  width: 100%;
  margin: 4px 0;
}

/* Comment box */
.comment-box {
  margin-top: 16px;
}
.comment-box textarea {
  width: 100%;
  height: 70px;
  background: #111;
  color: #fff;
  border: 1px solid #333;
  padding: 6px;
  border-radius: 4px;
  font-size: 14px;
}
.comment-box button {
  margin-top: 6px;
}

/* Next/Previous container */
.nav-episodes {
  margin-top: 12px;
}
</style>
</head>
<body>

<div class="container">

  <!-- PLAYER AREA -->
  <div class="player-area">
    <video id="player" controls crossorigin></video>
  </div>

  <!-- Next / Previous episode buttons -->
  <div class="nav-episodes">
    <button id="prevEpisodeBtn" class="nav">‚èÆ Previous Episode</button>
    <button id="nextEpisodeBtn" class="nav">‚è≠ Next Episode</button>
  </div>

  <!-- SERIES INFO & CONTROLS BELOW -->
  <h2 id="seriesTitle"></h2>
  <p id="seriesMeta"></p>
  <p id="seriesSynopsis"></p>

  <button id="watchNowBtn" class="primary">‚ñ∂ Watch Now</button>
  <button id="toggleEpisodesBtn" class="secondary">Show/Hide Episodes</button>
  <button id="shareBtn" class="secondary">üì§ Share WhatsApp</button>

  <div id="episodes"></div>

  <!-- Comment Section -->
  <div class="comment-box">
    <textarea id="commentInput" placeholder="Add a comment..."></textarea>
    <button id="submitComment" class="primary">Submit Comment</button>
    <div id="commentList"></div>
  </div>

</div>

<!-- SERIES DATA -->
<script src="series-data.js"></script>

<!-- Ads and PIN logic -->
<script src="auth.js"></script>
<script src="pins.js"></script>
<script src="ads.js"></script>

<!-- Plyr JS -->
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<script>
/* ===============================
   SERIES & PLAYER LOGIC
================================ */
const params = new URLSearchParams(location.search);
const seriesId = params.get("id");
const serie = SERIES.find(s => s.id === seriesId);
if (!serie) location.replace("series.html");

// Populate text
seriesTitle.textContent = serie.title;
seriesMeta.textContent = `${serie.genre} ‚Ä¢ ${serie.country} ‚Ä¢ ${serie.year}`;
seriesSynopsis.textContent = serie.synopsis || "";

// OG tags for WhatsApp
document.querySelector('meta[property="og:title"]').content = serie.title;
document.querySelector('meta[property="og:description"]').content = serie.synopsis || "";
document.querySelector('meta[property="og:image"]').content = serie.poster;

/* ===============================
   PLYR PLAYER SETUP
================================ */
const player = new Plyr('#player', {
  autoplay: false,
  controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen']
});

const storageKey = `resume_${seriesId}`;
let currentEpisode = 0;

// Build episode buttons
const episodesContainer = document.getElementById('episodes');
serie.episodes.forEach((ep, index) => {
  const btn = document.createElement("button");
  btn.textContent = ep.title;
  btn.onclick = () => loadEpisode(index, true);
  episodesContainer.appendChild(btn);
});

// Load episode
function loadEpisode(index, userAction = false) {
  const ep = serie.episodes[index];
  currentEpisode = index;

  if (ep.video.includes("youtube") || ep.video.includes("youtu.be")) {
    player.source = {
      type: 'video',
      sources: [{ src: ep.video, provider: 'youtube' }]
    };
  } else if (ep.video.includes("vimeo")) {
    player.source = {
      type: 'video',
      sources: [{ src: ep.video, provider: 'vimeo' }]
    };
  } else {
    player.source = {
      type: 'video',
      sources: [{ src: ep.video, type: 'video/mp4' }]
    };
  }

  localStorage.setItem(storageKey, JSON.stringify({
    episode: index,
    time: 0
  }));

  if (userAction && userHasActivePIN()) {
    player.fullscreen.enter();
  }

  player.play();
}

// Auto-resume
const saved = JSON.parse(localStorage.getItem(storageKey));
if (saved && serie.episodes[saved.episode]) {
  loadEpisode(saved.episode);
  player.currentTime = saved.time || 0;
}

// Save playback time
player.on('timeupdate', () => {
  const current = JSON.parse(localStorage.getItem(storageKey)) || {};
  current.time = player.currentTime;
  localStorage.setItem(storageKey, JSON.stringify(current));
});

// Auto-next
player.on('ended', () => {
  const next = currentEpisode + 1;
  if (serie.episodes[next]) loadEpisode(next);
});

// Watch Now button
watchNowBtn.onclick = () => {
  const startEp = saved?.episode || 0;
  loadEpisode(startEp, true);
};

// Next / Previous buttons
nextEpisodeBtn.onclick = () => {
  const next = currentEpisode + 1;
  if (serie.episodes[next]) loadEpisode(next, true);
};
prevEpisodeBtn.onclick = () => {
  const prev = currentEpisode - 1;
  if (serie.episodes[prev]) loadEpisode(prev, true);
};

// Toggle episodes
let episodesVisible = true;
toggleEpisodesBtn.onclick = () => {
  episodesVisible = !episodesVisible;
  episodesContainer.style.display = episodesVisible ? "block" : "none";
};

// Share WhatsApp
shareBtn.onclick = () => {
  const text = encodeURIComponent(
    `${serie.title}\n\n${serie.synopsis}\n\nWatch üëâ https://bit.ly/busanso`
  );
  window.open(`https://api.whatsapp.com/send?text=${text}`, "_blank");
};

// Dummy auth checker (like original)
function userHasActivePIN() {
  return window.ACTIVE_PIN === true;
}

/* ===============================
   COMMENTS
================================ */
submitComment.onclick = () => {
  const val = commentInput.value.trim();
  if (!val) return;
  const div = document.createElement("div");
  div.textContent = val;
  commentList.appendChild(div);
  commentInput.value = "";
};
</script>
</body>
</html>
