<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enter PIN</title>

<style>
body{
  font-family:Arial,sans-serif;
  background:#111;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}

.card{
  background:#1a1a1a;
  padding:30px;
  border-radius:10px;
  width:100%;
  max-width:380px;
  text-align:center;
}

input{
  width:90%;
  padding:12px;
  margin:15px 0;
  border-radius:6px;
  border:none;
  font-size:16px;
}

button{
  padding:12px 25px;
  background:#ff7a18;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}

button:hover{ background:#ffb400; }

#msg{
  margin-top:15px;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="card">
  <h2>Enter Your PIN</h2>
  <input id="pinInput" placeholder="Enter PIN">
  <button id="loginBtn">Login</button>
  <div id="msg"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ðŸ”¥ Firebase Init (ONCE) */
if(!firebase.apps.length){
  firebase.initializeApp({
    apiKey: "AIzaSyBGGV9F3Nv13nRJ8t4QCP5Y0IosmKfYz1s",
    authDomain: "busanso-pins.firebaseapp.com",
    databaseURL: "https://busanso-pins-default-rtdb.firebaseio.com",
    projectId: "busanso-pins",
    storageBucket: "busanso-pins.firebasestorage.app",
    messagingSenderId: "137040014808",
    appId: "1:137040014808:web:b0684e17b6b0328da596ad"
  });
}

const db = firebase.database();

/* ðŸ“± DEVICE ID â€” CREATED ONCE */
(function ensureDeviceId(){
  let deviceId = localStorage.getItem("deviceId");
  if(!deviceId){
    deviceId = "device_" + crypto.randomUUID();
    localStorage.setItem("deviceId", deviceId);
  }
  window.DEVICE_ID = deviceId;
})();

/* ðŸ” LOGIN */
document.getElementById("loginBtn").onclick = async function(){
  const pin = document.getElementById("pinInput").value.trim();
  const msg = document.getElementById("msg");
  msg.style.color = "#ffb400";

  if(!pin){
    msg.textContent = "Please enter PIN";
    return;
  }

  try{
    const snap = await db.ref("pins/" + pin).get();

    if(!snap.exists()){
      msg.textContent = "Incorrect PIN";
      return;
    }

    const data = snap.val();
    const now = Date.now();
    const deviceId = window.DEVICE_ID;

    /* â± EXPIRED */
    if(data.expiry && now > data.expiry){
      msg.textContent = "PIN expired";
      return;
    }

    /* ðŸ”’ USED ON ANOTHER DEVICE */
    if(data.activeDevice && data.activeDevice !== deviceId){
      msg.textContent = "PIN already used on another device";
      return;
    }

    /* âœ… LOCK PIN TO THIS DEVICE */
    await db.ref("pins/" + pin).update({
      activeDevice: deviceId
    });

    /* ðŸ’¾ STORE LOCALLY */
    localStorage.setItem("activePIN", pin);
    localStorage.setItem("activePackage", JSON.stringify(data));

    msg.style.color = "#00ff66";
    msg.textContent = "Success! Redirectingâ€¦";

    setTimeout(() => {
      location.href = "watch.html";
    }, 1200);

  }catch(err){
    console.error(err);
    msg.textContent = "Network error. Try again.";
  }
};
</script>

</body>
</html>
