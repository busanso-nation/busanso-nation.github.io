<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enter PIN</title>
<style>
body {font-family: Arial,sans-serif;background:#111;color:#fff;display:flex;justify-content:center;align-items:center;height:100vh;}
.card {background:#1a1a1a;padding:30px;border-radius:10px;width:100%;max-width:380px;text-align:center;}
input {width:90%;padding:12px;margin:15px 0;border-radius:6px;border:none;font-size:16px;}
button {padding:12px 25px;background:#ff7a18;border:none;border-radius:6px;font-weight:bold;cursor:pointer;}
button:hover { background:#ffb400; }
#msg {margin-top:15px;font-weight:bold;}
</style>
</head>
<body>
<div class="card">
  <h2>Enter Your PIN</h2>
  <input id="pinInput" placeholder="Enter PIN">
  <button onclick="login()">Login</button>
  <div id="msg"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBGGV9F3Nv13nRJ8t4QCP5Y0IosmKfYz1s",
  authDomain: "busanso-pins.firebaseapp.com",
  databaseURL: "https://busanso-pins-default-rtdb.firebaseio.com",
  projectId: "busanso-pins",
  storageBucket: "busanso-pins.firebasestorage.app",
  messagingSenderId: "137040014808",
  appId: "1:137040014808:web:b0684e17b6b0328da596ad"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Get / generate device ID
function getDeviceId(){
  let id = localStorage.getItem("deviceId");
  if(!id){
    id = "device_" + Math.random().toString(36).slice(2);
    localStorage.setItem("deviceId", id);
  }
  return id;
}

// Auto-redirect if PIN exists
const storedPIN = localStorage.getItem("activePIN");
if(storedPIN) {
  window.location.href = "watch.html";
}

async function login(){
  const pin = document.getElementById("pinInput").value.trim();
  const msg = document.getElementById("msg");
  msg.style.color = "#ffb400";

  if(!pin){ msg.textContent="Enter PIN"; return; }

  try{
    const snapshot = await db.ref("pins/"+pin).get();
    if(!snapshot.exists()){
      msg.textContent="Incorrect PIN"; return;
    }

    const data = snapshot.val();
    const now = Date.now();
    const deviceId = getDeviceId();

    // Expired PIN
    if(data.expiry && now > data.expiry){
      msg.textContent="Your subscription has expired";
      return;
    }

    // Bind device if first login
    if(!data.activeDevice){
      await db.ref("pins/"+pin+"/activeDevice").set(deviceId);
    }

    // Success
    localStorage.setItem("activePIN", pin);
localStorage.setItem("pinExpiry", data.expiry);

    localStorage.setItem("activePackage", JSON.stringify(data));
    msg.style.color="#00ff66";
    msg.textContent="Login successful! Redirectingâ€¦";
    setTimeout(()=>window.location.href="watch.html",1200);

  } catch(err){
    console.error(err);
    msg.textContent="Network error. Try again.";
  }
}
</script>
</body>
</html>
