<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enter PIN</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#111;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}

.card {
  background:#1a1a1a;
  padding:30px;
  border-radius:10px;
  width:100%;
  max-width:380px;
  text-align:center;
}

input {
  width:90%;
  padding:12px;
  margin:15px 0;
  border-radius:6px;
  border:none;
  font-size:16px;
}

button {
  padding:12px 25px;
  background:#ff7a18;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}

button:hover { background:#ffb400; }

#msg {
  margin-top:15px;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="card">
  <h2>Enter Your PIN</h2>
  <input id="pinInput" placeholder="Enter PIN">
  <button onclick="login()">Login</button>
  <div id="msg"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ðŸ”¥ Firebase Init (ONLY ONCE) */
firebase.initializeApp({
  apiKey: "AIzaSyBGGV9F3Nv13nRJ8t4QCP5Y0IosmKfYz1s",
  authDomain: "busanso-pins.firebaseapp.com",
  databaseURL: "https://busanso-pins-default-rtdb.firebaseio.com",
  projectId: "busanso-pins",
  storageBucket: "busanso-pins.firebasestorage.app",
  messagingSenderId: "137040014808",
  appId: "1:137040014808:web:b0684e17b6b0328da596ad"
});

const db = firebase.database();

/* ðŸ“± Device ID */
function getDeviceId() {
  let id = localStorage.getItem("deviceId");
  if (!id) {
    id = "device_" + Math.random().toString(36).slice(2);
    localStorage.setItem("deviceId", id);
  }
  return id;
}

/* ðŸ” LOGIN LOGIC */
async function login() {
  const pin = document.getElementById("pinInput").value.trim();
  const msg = document.getElementById("msg");
  msg.style.color = "#ffb400";

  if (!pin) {
    msg.textContent = "Enter PIN";
    return;
  }

  try {
    const snap = await db.ref("pins/" + pin).get();

    if (!snap.exists()) {
      msg.textContent = "Wrong PIN";
      return;
    }

    const data = snap.val();
    const now = Date.now();
    const deviceId = getDeviceId();

    /* â± Create expiry if missing */
    if (!data.expiry) {
      const daysMap = {
        Daily: 1,
        Weekly: 7,
        Monthly: 30,
        "Half-Year": 180,
        Annual: 365
      };

      const days = daysMap[data.type] || 1;
      data.expiry = now + days * 86400000;

      await db.ref("pins/" + pin).update({
        expiry: data.expiry,
        activeDevice: deviceId
      });
    }

    /* âŒ Expired */
    if (now > data.expiry) {
      msg.textContent = "PIN expired";
      return;
    }

    /* ðŸ”’ Used on another device */
    if (data.activeDevice && data.activeDevice !== deviceId) {
      msg.textContent = "PIN active on another device";
      return;
    }

    /* âœ… Success */
    await db.ref("pins/" + pin).update({
      activeDevice: deviceId
    });

    localStorage.setItem("activePIN", pin);
    msg.style.color = "#00ff66";
    msg.textContent = "Success! Redirectingâ€¦";

    setTimeout(() => location.href = "watch.html", 1200);

  } catch (e) {
    console.error(e);
    msg.textContent = "Network error";
  }
}
</script>

</body>
</html>
