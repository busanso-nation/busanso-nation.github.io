<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enter PIN</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
}

.card {
  background: #1a1a1a;
  padding: 30px;
  border-radius: 10px;
  width: 100%;
  max-width: 380px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,.6);
}

.card h2 {margin-bottom: 20px;}

input {
  width: 90%;
  padding: 12px;
  margin: 15px 0;
  border-radius: 6px;
  border: none;
  font-size: 16px;
  background: #222;
  color: #fff;
  text-align:center;
}

button {
  padding: 12px 25px;
  background: #ff7a18;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  width:100%;
}

button:hover { background: #ffb400; }

#msg{
  margin-top:12px;
  font-size:14px;
  min-height:18px;
  transition: .3s;
}

.msg-error{color:#ff4d4d;}
.msg-success{color:#00ff66;}
.msg-info{color:#ffb400;}
</style>
</head>

<body>

<div class="card">
  <h2>Enter Your Password</h2>
  <input id="pinInput" placeholder="Wandiika wano Password Jetwakuwade">
  <button onclick="login()">Login</button>
  <div id="msg"></div>
</div>
  <!-- Ad container -->
<div style="max-width:380px;margin:14px auto 0;text-align:center;">
  <script src="https://pl28597623.effectivegatecpm.com/47/af/6b/47af6bb4248b5c79dabea6b329d6d72f.js"></script>
</div>


<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ===== Firebase Config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBGGV9F3Nv13nRJ8t4QCP5Y0IosmKfYz1s",
  authDomain: "busanso-pins.firebaseapp.com",
  databaseURL: "https://busanso-pins-default-rtdb.firebaseio.com",
  projectId: "busanso-pins",
  storageBucket: "busanso-pins.firebasestorage.app",
  messagingSenderId: "137040014808",
  appId: "1:137040014808:web:b0684e17b6b0328da596ad"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===== Device ID ===== */
function getDeviceId(){
  let id = localStorage.getItem("deviceId");
  if(!id){
    id = "device_" + Math.random().toString(36).slice(2);
    localStorage.setItem("deviceId", id);
  }
  return id;
}

/* ===== LOGIN FUNCTION ===== */
async function login(){
  const pin = document.getElementById("pinInput").value.trim();
  const msg = document.getElementById("msg");

  msg.className = "msg-info";
  msg.textContent = "";

  if(!pin){
    msg.className = "msg-error";
    msg.textContent = "Enter your Password";
    return;
  }

  msg.className = "msg-info";
  msg.textContent = "Checking PIN...";

  try {
    const snapshot = await db.ref("pins/" + pin).get();

    if(!snapshot.exists()){
      msg.className = "msg-error";
      msg.textContent = "Wrong Password. Try again";
      return;
    }

    const data = snapshot.val();
    const now = Date.now();
    const deviceId = getDeviceId();

    /* Expired */
    if(data.expiry && now > data.expiry){
      msg.className = "msg-error";
      msg.textContent = "Your Subscription is expired";
      return;
    }

    /* Used on another device */
    if(data.activeDevice && data.activeDevice !== deviceId){
      msg.className = "msg-error";
      msg.textContent = "Hahaha, This Password belongs to someone else.";
      return;
    }

    /* Bind device */
    if(!data.activeDevice){
      await db.ref("pins/"+pin+"/activeDevice").set(deviceId);
    }

    /* Mark used */
    if(!data.used){
      await db.ref("pins/"+pin+"/used").set(true);
    }

    /* Success */
    localStorage.setItem("activePIN", pin);
    localStorage.setItem("pinExpiry", data.expiry);
    localStorage.setItem("activePackage", JSON.stringify(data));

    msg.className = "msg-success";
    msg.textContent = "Access granted — Welcome to Busanso Nation…";

    setTimeout(()=>{
      window.location.href = "watch.html";
    }, 1200);

  } catch(err){
    console.error(err);
    msg.className = "msg-error";
    msg.textContent = "Connection error. Try again.";
  }
}
</script>

</body>
</html>
